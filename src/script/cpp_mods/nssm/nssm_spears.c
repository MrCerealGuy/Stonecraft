/* WARNING: This file was automatically generated by lua2c. */

#ifdef __cplusplus
extern "C" {
#endif
#include <lua.h>
#include <lauxlib.h>
#include <lualib.h>
#ifdef __cplusplus
}
#endif
#include <stdio.h>
#include <stdlib.h>


#include <string.h>


#include <assert.h>

/* __add metamethod handler.
 * warning: assumes indices in range LUA_REGISTRYINDEX < x < 0 are relative. */
static void lc_add(lua_State * L, int idxa, int idxb) {
  if (lua_isnumber(L,idxa) && lua_isnumber(L,idxb)) {
    lua_pushnumber(L,lua_tonumber(L,idxa) + lua_tonumber(L,idxb));
  }
  else {
    if (luaL_getmetafield(L,idxa,"__add")||luaL_getmetafield(L,idxb,"__add")) {
      lua_pushvalue(L,idxa < 0 && idxa > LUA_REGISTRYINDEX ? idxa-1 : idxa);
      lua_pushvalue(L,idxb < 0 && idxb > LUA_REGISTRYINDEX ? idxb-2 : idxb);
      lua_call(L,2,1);
    }
    else {
      luaL_error(L, "attempt to perform arithmetic");
    }
  }
}


/* __mul metamethod handler.
 * warning: assumes indices in range LUA_REGISTRYINDEX < x < 0 are relative. */
static void lc_mul(lua_State * L, int idxa, int idxb) {
  if (lua_isnumber(L,idxa) && lua_isnumber(L,idxb)) {
    lua_pushnumber(L,lua_tonumber(L,idxa) * lua_tonumber(L,idxb));
  }
  else {
    if (luaL_getmetafield(L,idxa,"__mul")||luaL_getmetafield(L,idxb,"__mul")) {
      lua_pushvalue(L,idxa < 0 && idxa > LUA_REGISTRYINDEX ? idxa-1 : idxa);
      lua_pushvalue(L,idxb < 0 && idxb > LUA_REGISTRYINDEX ? idxb-2 : idxb);
      lua_call(L,2,1);
    }
    else {
      luaL_error(L, "attempt to perform arithmetic");
    }
  }
}


/* __unm metamethod handler.
 * warning: assumes indices in range LUA_REGISTRYINDEX < x < 0 are relative. */
static void lc_unm(lua_State * L, int idxa) {
  if (lua_isnumber(L,idxa)) {
    lua_pushnumber(L,- lua_tonumber(L, idxa));
  }
  else {
    if (luaL_getmetafield(L,idxa,"__unm")) {
      lua_pushvalue(L,idxa < 0 && idxa > LUA_REGISTRYINDEX ? idxa-1 : idxa);
      lua_call(L,1,1);
    }
    else {
      luaL_error(L, "attempt to perform arithmetic");
    }
  }
}


/* name: spears_shot
 * function(itemstack, player) */
static int lcf1_spears_shot (lua_State * L) {
  enum { lc_nformalargs = 2 };
  lua_settop(L,2);
  
  /* local spear = itemstack:get_name() .. '_entity' */
  lua_pushvalue(L,1);
  lua_pushliteral(L,"get_name");
  lua_gettable(L,-2);
  lua_insert(L,-2);
  lua_call(L,1,1);
  lua_pushliteral(L,"_entity");
  lua_concat(L,2);
  assert(lua_gettop(L) == 3);
  
  /* local playerpos = player:getpos() */
  lua_pushvalue(L,2);
  lua_pushliteral(L,"getpos");
  lua_gettable(L,-2);
  lua_insert(L,-2);
  lua_call(L,1,1);
  assert(lua_gettop(L) == 4);
  
  /* local obj = minetest.add_entity({x=playerpos.x,y=playerpos.y+1.5,z=playerpos.z}, spear) */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"add_entity");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_createtable(L,0,3);
  lua_pushliteral(L,"x");
  lua_pushliteral(L,"x");
  lua_gettable(L,4);
  lua_rawset(L,-3);
  lua_pushliteral(L,"y");
  lua_pushliteral(L,"y");
  lua_gettable(L,4);
  lua_pushnumber(L,1.5);
  lc_add(L,-2,-1);
  lua_remove(L,-2);
  lua_remove(L,-2);
  lua_rawset(L,-3);
  lua_pushliteral(L,"z");
  lua_pushliteral(L,"z");
  lua_gettable(L,4);
  lua_rawset(L,-3);
  lua_pushvalue(L,3);
  lua_call(L,2,1);
  assert(lua_gettop(L) == 5);
  
  /* local dir = player:get_look_dir() */
  lua_pushvalue(L,2);
  lua_pushliteral(L,"get_look_dir");
  lua_gettable(L,-2);
  lua_insert(L,-2);
  lua_call(L,1,1);
  assert(lua_gettop(L) == 6);
  
  /* local sp = 16 */
  lua_pushnumber(L,16);
  assert(lua_gettop(L) == 7);
  
  /* local dr = .3 */
  lua_pushnumber(L,0.3);
  assert(lua_gettop(L) == 8);
  
  /* local gravity = 9.8 */
  lua_pushnumber(L,9.8);
  assert(lua_gettop(L) == 9);
  
  /* obj:setvelocity({x=dir.x*sp, y=dir.y*sp, z=dir.z*sp}) */
  lua_pushvalue(L,5);
  lua_pushliteral(L,"setvelocity");
  lua_gettable(L,-2);
  lua_insert(L,-2);
  lua_createtable(L,0,3);
  lua_pushliteral(L,"x");
  lua_pushliteral(L,"x");
  lua_gettable(L,6);
  lc_mul(L,-1,7);
  lua_remove(L,-2);
  lua_rawset(L,-3);
  lua_pushliteral(L,"y");
  lua_pushliteral(L,"y");
  lua_gettable(L,6);
  lc_mul(L,-1,7);
  lua_remove(L,-2);
  lua_rawset(L,-3);
  lua_pushliteral(L,"z");
  lua_pushliteral(L,"z");
  lua_gettable(L,6);
  lc_mul(L,-1,7);
  lua_remove(L,-2);
  lua_rawset(L,-3);
  lua_call(L,2,0);
  assert(lua_gettop(L) == 9);
  
  /* obj:setacceleration({x=-dir.x*dr, y=-gravity, z=-dir.z*dr}) */
  lua_pushvalue(L,5);
  lua_pushliteral(L,"setacceleration");
  lua_gettable(L,-2);
  lua_insert(L,-2);
  lua_createtable(L,0,3);
  lua_pushliteral(L,"x");
  lua_pushliteral(L,"x");
  lua_gettable(L,6);
  lc_unm(L,-1);
  lua_remove(L,-2);
  lc_mul(L,-1,8);
  lua_remove(L,-2);
  lua_rawset(L,-3);
  lua_pushliteral(L,"y");
  lc_unm(L,9);
  lua_rawset(L,-3);
  lua_pushliteral(L,"z");
  lua_pushliteral(L,"z");
  lua_gettable(L,6);
  lc_unm(L,-1);
  lua_remove(L,-2);
  lc_mul(L,-1,8);
  lua_remove(L,-2);
  lua_rawset(L,-3);
  lua_call(L,2,0);
  assert(lua_gettop(L) == 9);
  
  /* obj:setyaw(player:get_look_yaw()+math.pi) */
  lua_pushvalue(L,5);
  lua_pushliteral(L,"setyaw");
  lua_gettable(L,-2);
  lua_insert(L,-2);
  lua_pushvalue(L,2);
  lua_pushliteral(L,"get_look_yaw");
  lua_gettable(L,-2);
  lua_insert(L,-2);
  lua_call(L,1,1);
  lua_getfield(L,LUA_ENVIRONINDEX,"math");
  lua_pushliteral(L,"pi");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lc_add(L,-2,-1);
  lua_remove(L,-2);
  lua_remove(L,-2);
  lua_call(L,2,0);
  assert(lua_gettop(L) == 9);
  
  /* minetest.sound_play("spears_sound", {pos=playerpos}) */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"sound_play");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"spears_sound");
  lua_createtable(L,0,1);
  lua_pushliteral(L,"pos");
  lua_pushvalue(L,4);
  lua_rawset(L,-3);
  lua_call(L,2,0);
  assert(lua_gettop(L) == 9);
  
  /* obj:get_luaentity().wear = itemstack:get_wear() */
  lua_pushvalue(L,1);
  lua_pushliteral(L,"get_wear");
  lua_gettable(L,-2);
  lua_insert(L,-2);
  lua_call(L,1,1);
  lua_pushvalue(L,5);
  lua_pushliteral(L,"get_luaentity");
  lua_gettable(L,-2);
  lua_insert(L,-2);
  lua_call(L,1,1);
  lua_insert(L,-2);
  lua_pushliteral(L,"wear");
  lua_insert(L,-2);
  lua_settable(L,-3);
  lua_pop(L,1);
  assert(lua_gettop(L) == 9);
  
  /* return true */
  lua_pushboolean(L,1);
  return 1;
  assert(lua_gettop(L) == 9);
}


/* pushes new closure table onto the stack, using closure table at
 * given index as its parent */
static void lc_newclosuretable(lua_State * L, int idx) {

  lua_newtable(L);
  lua_pushvalue(L,idx);
  lua_rawseti(L,-2,0);


}

/* gets upvalue with ID varid by consulting upvalue table at index
 * tidx for the upvalue table at given nesting level. */
static void lc_getupvalue(lua_State * L, int tidx, int level, int varid) {
  if (level == 0) {
    lua_rawgeti(L,tidx,varid);
  }
  else {
    lua_pushvalue(L,tidx);
    while (--level >= 0) {
      lua_rawgeti(L,tidx,0); /* 0 links to parent table */
      lua_remove(L,-2);
      tidx = -1;
    }
    lua_rawgeti(L,-1,varid);
    lua_remove(L,-2);
  }
}


/* __div metamethod handler.
 * warning: assumes indices in range LUA_REGISTRYINDEX < x < 0 are relative. */
static void lc_div(lua_State * L, int idxa, int idxb) {
  if (lua_isnumber(L,idxa) && lua_isnumber(L,idxb)) {
    lua_pushnumber(L,lua_tonumber(L,idxa) / lua_tonumber(L,idxb));
  }
  else {
    if (luaL_getmetafield(L,idxa,"__div")||luaL_getmetafield(L,idxb,"__div")) {
      lua_pushvalue(L,idxa < 0 && idxa > LUA_REGISTRYINDEX ? idxa-1 : idxa);
      lua_pushvalue(L,idxb < 0 && idxb > LUA_REGISTRYINDEX ? idxb-2 : idxb);
      lua_call(L,2,1);
    }
    else {
      luaL_error(L, "attempt to perform arithmetic");
    }
  }
}


/* function(self, puncher) */
static int lcf7 (lua_State * L) {
  enum { lc_nformalargs = 2 };
  lua_settop(L,2);
  
  /* if puncher then */
  enum { lc2 = 2 };
  if (lua_toboolean(L,2)) {
    
    /* if puncher:is_player() then */
    enum { lc3 = 2 };
    lua_pushvalue(L,2);
    lua_pushliteral(L,"is_player");
    lua_gettable(L,-2);
    lua_insert(L,-2);
    lua_call(L,1,1);
    const int lc4 = lua_toboolean(L,-1);
    lua_pop(L,1);
    if (lc4) {
      
      /* local stack = {name='nssm:spear_' .. kind, wear=self.wear+65535/toughness} */
      lua_createtable(L,0,2);
      lua_pushliteral(L,"name");
      lua_pushliteral(L,"nssm:spear_");
      lc_getupvalue(L,lua_upvalueindex(1),0,1);
      lua_concat(L,2);
      lua_rawset(L,-3);
      lua_pushliteral(L,"wear");
      lua_pushliteral(L,"wear");
      lua_gettable(L,1);
      lua_pushnumber(L,65535);
      lc_getupvalue(L,lua_upvalueindex(1),0,3);
      lc_div(L,-2,-1);
      lua_remove(L,-2);
      lua_remove(L,-2);
      lc_add(L,-2,-1);
      lua_remove(L,-2);
      lua_remove(L,-2);
      lua_rawset(L,-3);
      assert(lua_gettop(L) == 3);
      
      /* local inv = puncher:get_inventory() */
      lua_pushvalue(L,2);
      lua_pushliteral(L,"get_inventory");
      lua_gettable(L,-2);
      lua_insert(L,-2);
      lua_call(L,1,1);
      assert(lua_gettop(L) == 4);
      
      /* if inv:room_for_item("main", stack) then */
      enum { lc5 = 4 };
      lua_pushvalue(L,4);
      lua_pushliteral(L,"room_for_item");
      lua_gettable(L,-2);
      lua_insert(L,-2);
      lua_pushliteral(L,"main");
      lua_pushvalue(L,3);
      lua_call(L,3,1);
      const int lc6 = lua_toboolean(L,-1);
      lua_pop(L,1);
      if (lc6) {
        
        /* inv:add_item("main", stack) */
        lua_pushvalue(L,4);
        lua_pushliteral(L,"add_item");
        lua_gettable(L,-2);
        lua_insert(L,-2);
        lua_pushliteral(L,"main");
        lua_pushvalue(L,3);
        lua_call(L,3,0);
        assert(lua_gettop(L) == 4);
        
        /* self.object:remove() */
        lua_pushliteral(L,"object");
        lua_gettable(L,1);
        lua_pushliteral(L,"remove");
        lua_gettable(L,-2);
        lua_insert(L,-2);
        lua_call(L,1,0);
        assert(lua_gettop(L) == 4);
      }
      lua_settop(L,lc5);
      assert(lua_gettop(L) == 4);
    }
    lua_settop(L,lc3);
    assert(lua_gettop(L) == 2);
  }
  lua_settop(L,lc2);
  assert(lua_gettop(L) == 2);
  return 0;
}


/* __sub metamethod handler.
 * warning: assumes indices in range LUA_REGISTRYINDEX < x < 0 are relative. */
static void lc_sub(lua_State * L, int idxa, int idxb) {
  if (lua_isnumber(L,idxa) && lua_isnumber(L,idxb)) {
    lua_pushnumber(L,lua_tonumber(L,idxa) - lua_tonumber(L,idxb));
  }
  else {
    if (luaL_getmetafield(L,idxa,"__sub")||luaL_getmetafield(L,idxb,"__sub")) {
      lua_pushvalue(L,idxa < 0 && idxa > LUA_REGISTRYINDEX ? idxa-1 : idxa);
      lua_pushvalue(L,idxb < 0 && idxb > LUA_REGISTRYINDEX ? idxb-2 : idxb);
      lua_call(L,2,1);
    }
    else {
      luaL_error(L, "attempt to perform arithmetic");
    }
  }
}


#include <math.h>

/* __pow metamethod handler.
 * warning: assumes indices in range LUA_REGISTRYINDEX < x < 0 are relative. */
static void lc_pow(lua_State * L, int idxa, int idxb) {
  if (lua_isnumber(L,idxa) && lua_isnumber(L,idxb)) {
    lua_pushnumber(L,pow(lua_tonumber(L,idxa),lua_tonumber(L,idxb)));
  }
  else {
    if (luaL_getmetafield(L,idxa,"__pow")||luaL_getmetafield(L,idxb,"__pow")) {
      lua_pushvalue(L,idxa < 0 && idxa > LUA_REGISTRYINDEX ? idxa-1 : idxa);
      lua_pushvalue(L,idxb < 0 && idxb > LUA_REGISTRYINDEX ? idxb-2 : idxb);
      lua_call(L,2,1);
    }
    else {
      luaL_error(L, "attempt to perform arithmetic");
    }
  }
}


/* name: SPEAR_ENTITY.on_step
 * function(self, dtime) */
static int lcf1_SPEAR_ENTITY_on_step (lua_State * L) {
  lua_checkstack(L,22);
  enum { lc_nformalargs = 2 };
  lua_settop(L,2);
  
  /* self.timer=self.timer+dtime */
  lua_pushliteral(L,"timer");
  lua_gettable(L,1);
  lc_add(L,-1,2);
  lua_remove(L,-2);
  lua_pushliteral(L,"timer");
  lua_insert(L,-2);
  lua_settable(L,1);
  assert(lua_gettop(L) == 2);
  
  /* local pos = self.object:getpos() */
  lua_pushliteral(L,"object");
  lua_gettable(L,1);
  lua_pushliteral(L,"getpos");
  lua_gettable(L,-2);
  lua_insert(L,-2);
  lua_call(L,1,1);
  assert(lua_gettop(L) == 3);
  
  /* local node = minetest.get_node(pos) */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"get_node");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushvalue(L,3);
  lua_call(L,1,1);
  assert(lua_gettop(L) == 4);
  
  /* if not self.wear then */
  enum { lc8 = 4 };
  lua_pushliteral(L,"wear");
  lua_gettable(L,1);
  lua_pushboolean(L,!(lua_toboolean(L,-1)));
  lua_remove(L,-2);
  const int lc9 = lua_toboolean(L,-1);
  lua_pop(L,1);
  if (lc9) {
    
    /* self.object:remove() */
    lua_pushliteral(L,"object");
    lua_gettable(L,1);
    lua_pushliteral(L,"remove");
    lua_gettable(L,-2);
    lua_insert(L,-2);
    lua_call(L,1,0);
    assert(lua_gettop(L) == 4);
    
    /* return */
    return 0;
    assert(lua_gettop(L) == 4);
  }
  lua_settop(L,lc8);
  assert(lua_gettop(L) == 4);
  
  /* if self.lastpos.x~=nil then */
  enum { lc10 = 4 };
  lua_pushliteral(L,"lastpos");
  lua_gettable(L,1);
  lua_pushliteral(L,"x");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushnil(L);
  const int lc11 = lua_equal(L,-2,-1);
  lua_pop(L,2);
  lua_pushboolean(L,lc11);
  lua_pushboolean(L,!(lua_toboolean(L,-1)));
  lua_remove(L,-2);
  const int lc12 = lua_toboolean(L,-1);
  lua_pop(L,1);
  if (lc12) {
    
    /* if node.name ~= "air" and not (string.find(node.name, 'grass') and not string.find(node.name, 'dirt')) and not string.find(node.name, 'flowers:') and not string.find(node.name, 'farming:') then */
    enum { lc13 = 4 };
    lua_pushliteral(L,"name");
    lua_gettable(L,4);
    lua_pushliteral(L,"air");
    const int lc14 = lua_equal(L,-2,-1);
    lua_pop(L,2);
    lua_pushboolean(L,lc14);
    lua_pushboolean(L,!(lua_toboolean(L,-1)));
    lua_remove(L,-2);
    if (lua_toboolean(L,-1)) {
      lua_pop(L,1);
      lua_getfield(L,LUA_ENVIRONINDEX,"string");
      lua_pushliteral(L,"find");
      lua_gettable(L,-2);
      lua_remove(L,-2);
      lua_pushliteral(L,"name");
      lua_gettable(L,4);
      lua_pushliteral(L,"grass");
      lua_call(L,2,1);
      if (lua_toboolean(L,-1)) {
        lua_pop(L,1);
        lua_getfield(L,LUA_ENVIRONINDEX,"string");
        lua_pushliteral(L,"find");
        lua_gettable(L,-2);
        lua_remove(L,-2);
        lua_pushliteral(L,"name");
        lua_gettable(L,4);
        lua_pushliteral(L,"dirt");
        lua_call(L,2,1);
        lua_pushboolean(L,!(lua_toboolean(L,-1)));
        lua_remove(L,-2);
      }
      lua_pushboolean(L,!(lua_toboolean(L,-1)));
      lua_remove(L,-2);
    }
    if (lua_toboolean(L,-1)) {
      lua_pop(L,1);
      lua_getfield(L,LUA_ENVIRONINDEX,"string");
      lua_pushliteral(L,"find");
      lua_gettable(L,-2);
      lua_remove(L,-2);
      lua_pushliteral(L,"name");
      lua_gettable(L,4);
      lua_pushliteral(L,"flowers:");
      lua_call(L,2,1);
      lua_pushboolean(L,!(lua_toboolean(L,-1)));
      lua_remove(L,-2);
    }
    if (lua_toboolean(L,-1)) {
      lua_pop(L,1);
      lua_getfield(L,LUA_ENVIRONINDEX,"string");
      lua_pushliteral(L,"find");
      lua_gettable(L,-2);
      lua_remove(L,-2);
      lua_pushliteral(L,"name");
      lua_gettable(L,4);
      lua_pushliteral(L,"farming:");
      lua_call(L,2,1);
      lua_pushboolean(L,!(lua_toboolean(L,-1)));
      lua_remove(L,-2);
    }
    const int lc15 = lua_toboolean(L,-1);
    lua_pop(L,1);
    if (lc15) {
      
      /* self.object:remove() */
      lua_pushliteral(L,"object");
      lua_gettable(L,1);
      lua_pushliteral(L,"remove");
      lua_gettable(L,-2);
      lua_insert(L,-2);
      lua_call(L,1,0);
      assert(lua_gettop(L) == 4);
      
      /* if self.wear+65535/toughness < 65535 then */
      enum { lc16 = 4 };
      lua_pushliteral(L,"wear");
      lua_gettable(L,1);
      lua_pushnumber(L,65535);
      lc_getupvalue(L,lua_upvalueindex(1),0,3);
      lc_div(L,-2,-1);
      lua_remove(L,-2);
      lua_remove(L,-2);
      lc_add(L,-2,-1);
      lua_remove(L,-2);
      lua_remove(L,-2);
      lua_pushnumber(L,65535);
      const int lc17 = lua_lessthan(L,-2,-1);
      lua_pop(L,2);
      lua_pushboolean(L,lc17);
      const int lc18 = lua_toboolean(L,-1);
      lua_pop(L,1);
      if (lc18) {
        
        /* minetest.add_item(self.lastpos, {name='nssm:spear_' .. kind, wear=self.wear+65535/toughness}) */
        lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
        lua_pushliteral(L,"add_item");
        lua_gettable(L,-2);
        lua_remove(L,-2);
        lua_pushliteral(L,"lastpos");
        lua_gettable(L,1);
        lua_createtable(L,0,2);
        lua_pushliteral(L,"name");
        lua_pushliteral(L,"nssm:spear_");
        lc_getupvalue(L,lua_upvalueindex(1),0,1);
        lua_concat(L,2);
        lua_rawset(L,-3);
        lua_pushliteral(L,"wear");
        lua_pushliteral(L,"wear");
        lua_gettable(L,1);
        lua_pushnumber(L,65535);
        lc_getupvalue(L,lua_upvalueindex(1),0,3);
        lc_div(L,-2,-1);
        lua_remove(L,-2);
        lua_remove(L,-2);
        lc_add(L,-2,-1);
        lua_remove(L,-2);
        lua_remove(L,-2);
        lua_rawset(L,-3);
        lua_call(L,2,0);
        assert(lua_gettop(L) == 4);
      }
      lua_settop(L,lc16);
      assert(lua_gettop(L) == 4);
    }
    else {
      
      /* elseif self.timer>0.2 then */
      enum { lc19 = 4 };
      lua_pushnumber(L,0.2);
      lua_pushliteral(L,"timer");
      lua_gettable(L,1);
      const int lc20 = lua_lessthan(L,-2,-1);
      lua_pop(L,2);
      lua_pushboolean(L,lc20);
      const int lc21 = lua_toboolean(L,-1);
      lua_pop(L,1);
      if (lc21) {
        
        /* local objs = minetest.get_objects_inside_radius({x=pos.x,y=pos.y,z=pos.z}, 1) */
        lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
        lua_pushliteral(L,"get_objects_inside_radius");
        lua_gettable(L,-2);
        lua_remove(L,-2);
        lua_createtable(L,0,3);
        lua_pushliteral(L,"x");
        lua_pushliteral(L,"x");
        lua_gettable(L,3);
        lua_rawset(L,-3);
        lua_pushliteral(L,"y");
        lua_pushliteral(L,"y");
        lua_gettable(L,3);
        lua_rawset(L,-3);
        lua_pushliteral(L,"z");
        lua_pushliteral(L,"z");
        lua_gettable(L,3);
        lua_rawset(L,-3);
        lua_pushnumber(L,1);
        lua_call(L,2,1);
        assert(lua_gettop(L) == 5);
        
        /* for k, obj in pairs(objs) do
         * internal: local f, s, var = explist */
        enum { lc22 = 5 };
        lua_getfield(L,LUA_ENVIRONINDEX,"pairs");
        lua_pushvalue(L,5);
        lua_call(L,1,3);
        while (1) {
          
          /* internal: local var_1, ..., var_n = f(s, var)
           *           if var_1 == nil then break end
           *           var = var_1 */
          lua_pushvalue(L,-3);
          lua_pushvalue(L,-3);
          lua_pushvalue(L,-3);
          lua_call(L,2,2);
          if (lua_isnil(L,-2)) {
            break;
          }
          lua_pushvalue(L,-2);
          lua_replace(L,-4);
          
          /* internal: local k with idx 9
           * internal: local obj with idx 10 */
          
          
          /* if obj:get_luaentity() ~= nil then */
          enum { lc23 = 10 };
          lua_pushvalue(L,10);
          lua_pushliteral(L,"get_luaentity");
          lua_gettable(L,-2);
          lua_insert(L,-2);
          lua_call(L,1,1);
          lua_pushnil(L);
          const int lc24 = lua_equal(L,-2,-1);
          lua_pop(L,2);
          lua_pushboolean(L,lc24);
          lua_pushboolean(L,!(lua_toboolean(L,-1)));
          lua_remove(L,-2);
          const int lc25 = lua_toboolean(L,-1);
          lua_pop(L,1);
          if (lc25) {
            
            /* if obj:get_luaentity().name ~= "nssm:spear_" .. kind .. "_entity" and obj:get_luaentity().name ~= "__builtin:item" then */
            enum { lc26 = 10 };
            lua_pushvalue(L,10);
            lua_pushliteral(L,"get_luaentity");
            lua_gettable(L,-2);
            lua_insert(L,-2);
            lua_call(L,1,1);
            lua_pushliteral(L,"name");
            lua_gettable(L,-2);
            lua_remove(L,-2);
            lua_pushliteral(L,"nssm:spear_");
            lc_getupvalue(L,lua_upvalueindex(1),0,1);
            lua_pushliteral(L,"_entity");
            lua_concat(L,2);
            lua_concat(L,2);
            const int lc27 = lua_equal(L,-2,-1);
            lua_pop(L,2);
            lua_pushboolean(L,lc27);
            lua_pushboolean(L,!(lua_toboolean(L,-1)));
            lua_remove(L,-2);
            if (lua_toboolean(L,-1)) {
              lua_pop(L,1);
              lua_pushvalue(L,10);
              lua_pushliteral(L,"get_luaentity");
              lua_gettable(L,-2);
              lua_insert(L,-2);
              lua_call(L,1,1);
              lua_pushliteral(L,"name");
              lua_gettable(L,-2);
              lua_remove(L,-2);
              lua_pushliteral(L,"__builtin:item");
              const int lc28 = lua_equal(L,-2,-1);
              lua_pop(L,2);
              lua_pushboolean(L,lc28);
              lua_pushboolean(L,!(lua_toboolean(L,-1)));
              lua_remove(L,-2);
            }
            const int lc29 = lua_toboolean(L,-1);
            lua_pop(L,1);
            if (lc29) {
              
              /* local speed = vector.length(self.object:getvelocity()) */
              lua_getfield(L,LUA_ENVIRONINDEX,"vector");
              lua_pushliteral(L,"length");
              lua_gettable(L,-2);
              lua_remove(L,-2);
              const int lc30 = lua_gettop(L);
              lua_pushliteral(L,"object");
              lua_gettable(L,1);
              lua_pushliteral(L,"getvelocity");
              lua_gettable(L,-2);
              lua_insert(L,-2);
              lua_call(L,1,LUA_MULTRET);
              lua_call(L,(lua_gettop(L) - lc30),1);
              assert(lua_gettop(L) == 11);
              
              /* local damage = (speed + eq)^1.12-20 */
              lc_getupvalue(L,lua_upvalueindex(1),0,2);
              lc_add(L,11,-1);
              lua_remove(L,-2);
              lua_pushnumber(L,1.12);
              lc_pow(L,-2,-1);
              lua_remove(L,-2);
              lua_remove(L,-2);
              lua_pushnumber(L,20);
              lc_sub(L,-2,-1);
              lua_remove(L,-2);
              lua_remove(L,-2);
              assert(lua_gettop(L) == 12);
              
              /* obj:punch(self.object, 1.0, {
               * 								full_punch_interval=1.0,
               * 								damage_groups={fleshy=damage},
               * 							}, nil) */
              lua_pushvalue(L,10);
              lua_pushliteral(L,"punch");
              lua_gettable(L,-2);
              lua_insert(L,-2);
              lua_pushliteral(L,"object");
              lua_gettable(L,1);
              lua_pushnumber(L,1);
              lua_createtable(L,0,2);
              lua_pushliteral(L,"full_punch_interval");
              lua_pushnumber(L,1);
              lua_rawset(L,-3);
              lua_pushliteral(L,"damage_groups");
              lua_createtable(L,0,1);
              lua_pushliteral(L,"fleshy");
              lua_pushvalue(L,12);
              lua_rawset(L,-3);
              lua_rawset(L,-3);
              lua_pushnil(L);
              lua_call(L,5,0);
              assert(lua_gettop(L) == 12);
              
              /* self.object:remove() */
              lua_pushliteral(L,"object");
              lua_gettable(L,1);
              lua_pushliteral(L,"remove");
              lua_gettable(L,-2);
              lua_insert(L,-2);
              lua_call(L,1,0);
              assert(lua_gettop(L) == 12);
              
              /* if self.wear+65535/toughness < 65535 then */
              enum { lc31 = 12 };
              lua_pushliteral(L,"wear");
              lua_gettable(L,1);
              lua_pushnumber(L,65535);
              lc_getupvalue(L,lua_upvalueindex(1),0,3);
              lc_div(L,-2,-1);
              lua_remove(L,-2);
              lua_remove(L,-2);
              lc_add(L,-2,-1);
              lua_remove(L,-2);
              lua_remove(L,-2);
              lua_pushnumber(L,65535);
              const int lc32 = lua_lessthan(L,-2,-1);
              lua_pop(L,2);
              lua_pushboolean(L,lc32);
              const int lc33 = lua_toboolean(L,-1);
              lua_pop(L,1);
              if (lc33) {
                
                /* minetest.add_item(self.lastpos, {name='nssm:spear_' .. kind, wear=self.wear+65535/toughness}) */
                lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
                lua_pushliteral(L,"add_item");
                lua_gettable(L,-2);
                lua_remove(L,-2);
                lua_pushliteral(L,"lastpos");
                lua_gettable(L,1);
                lua_createtable(L,0,2);
                lua_pushliteral(L,"name");
                lua_pushliteral(L,"nssm:spear_");
                lc_getupvalue(L,lua_upvalueindex(1),0,1);
                lua_concat(L,2);
                lua_rawset(L,-3);
                lua_pushliteral(L,"wear");
                lua_pushliteral(L,"wear");
                lua_gettable(L,1);
                lua_pushnumber(L,65535);
                lc_getupvalue(L,lua_upvalueindex(1),0,3);
                lc_div(L,-2,-1);
                lua_remove(L,-2);
                lua_remove(L,-2);
                lc_add(L,-2,-1);
                lua_remove(L,-2);
                lua_remove(L,-2);
                lua_rawset(L,-3);
                lua_call(L,2,0);
                assert(lua_gettop(L) == 12);
              }
              lua_settop(L,lc31);
              assert(lua_gettop(L) == 12);
            }
            lua_settop(L,lc26);
            assert(lua_gettop(L) == 10);
          }
          lua_settop(L,lc23);
          assert(lua_gettop(L) == 10);
          
          /* internal: stack cleanup on scope exit */
          lua_pop(L,2);
        }
        lua_settop(L,lc22);
        assert(lua_gettop(L) == 5);
      }
      lua_settop(L,lc19);
    }
    lua_settop(L,lc13);
    assert(lua_gettop(L) == 4);
  }
  lua_settop(L,lc10);
  assert(lua_gettop(L) == 4);
  
  /* self.lastpos={x=pos.x, y=pos.y, z=pos.z} */
  lua_createtable(L,0,3);
  lua_pushliteral(L,"x");
  lua_pushliteral(L,"x");
  lua_gettable(L,3);
  lua_rawset(L,-3);
  lua_pushliteral(L,"y");
  lua_pushliteral(L,"y");
  lua_gettable(L,3);
  lua_rawset(L,-3);
  lua_pushliteral(L,"z");
  lua_pushliteral(L,"z");
  lua_gettable(L,3);
  lua_rawset(L,-3);
  lua_pushliteral(L,"lastpos");
  lua_insert(L,-2);
  lua_settable(L,1);
  assert(lua_gettop(L) == 4);
  return 0;
}


/* name: spears_set_entity
 * function(kind, eq, toughness) */
static int lcf1_spears_set_entity (lua_State * L) {
  enum { lc_nformalargs = 3 };
  lua_settop(L,3);
  lc_newclosuretable(L,lua_upvalueindex(1));
  enum { lc1 = 4 };
  assert((lua_gettop(L) == lc1));
  lua_pushvalue(L,1);
  lua_rawseti(L,-2,1);
  lua_pushvalue(L,2);
  lua_rawseti(L,-2,2);
  lua_pushvalue(L,3);
  lua_rawseti(L,-2,3);
  
  /* local SPEAR_ENTITY={
   * 		physical = false,
   * 		timer=0,
   * 		visual = "wielditem",
   * 		visual_size = {x=0.15, y=0.1},
   * 		textures = {"nssm:spear_" .. kind},
   * 		lastpos={},
   * 		collisionbox = {0,0,0,0,0,0},
   * 		on_punch = function(self, puncher)
   * 			if puncher then
   * 				if puncher:is_player() then
   * 					local stack = {name='nssm:spear_' .. kind, wear=self.wear+65535/toughness}
   * 					local inv = puncher:get_inventory()
   * 					if inv:room_for_item("main", stack) then
   * 						inv:add_item("main", stack)
   * 						self.object:remove()
   * 					end
   * 				end
   * 			end
   * 		end,
   * 	} */
  lua_createtable(L,0,8);
  lua_pushliteral(L,"physical");
  lua_pushboolean(L,0);
  lua_rawset(L,-3);
  lua_pushliteral(L,"timer");
  lua_pushnumber(L,0);
  lua_rawset(L,-3);
  lua_pushliteral(L,"visual");
  lua_pushliteral(L,"wielditem");
  lua_rawset(L,-3);
  lua_pushliteral(L,"visual_size");
  lua_createtable(L,0,2);
  lua_pushliteral(L,"x");
  lua_pushnumber(L,0.15);
  lua_rawset(L,-3);
  lua_pushliteral(L,"y");
  lua_pushnumber(L,0.1);
  lua_rawset(L,-3);
  lua_rawset(L,-3);
  lua_pushliteral(L,"textures");
  lua_createtable(L,1,0);
  lua_pushliteral(L,"nssm:spear_");
  lc_getupvalue(L,lc1,0,1);
  lua_concat(L,2);
  lua_rawseti(L,-2,1);
  lua_rawset(L,-3);
  lua_pushliteral(L,"lastpos");
  lua_newtable(L);
  lua_rawset(L,-3);
  lua_pushliteral(L,"collisionbox");
  lua_createtable(L,6,0);
  lua_pushnumber(L,0);
  lua_rawseti(L,-2,1);
  lua_pushnumber(L,0);
  lua_rawseti(L,-2,2);
  lua_pushnumber(L,0);
  lua_rawseti(L,-2,3);
  lua_pushnumber(L,0);
  lua_rawseti(L,-2,4);
  lua_pushnumber(L,0);
  lua_rawseti(L,-2,5);
  lua_pushnumber(L,0);
  lua_rawseti(L,-2,6);
  lua_rawset(L,-3);
  lua_pushliteral(L,"on_punch");
  lua_pushvalue(L,lc1);
  lua_pushcclosure(L,lcf7,1);
  lua_rawset(L,-3);
  assert(lua_gettop(L) == 5);
  
  /* SPEAR_ENTITY.on_step = function(self, dtime)
   * 		self.timer=self.timer+dtime
   * 		local pos = self.object:getpos()
   * 		local node = minetest.get_node(pos)
   * 		if not self.wear then
   * 			self.object:remove()
   * 			return
   * 		end
   * 		if self.lastpos.x~=nil then
   * 			if node.name ~= "air" and not (string.find(node.name, 'grass') and not string.find(node.name, 'dirt')) and not string.find(node.name, 'flowers:') and not string.find(node.name, 'farming:') then
   * 				self.object:remove()
   * 				if self.wear+65535/toughness < 65535 then
   * 					minetest.add_item(self.lastpos, {name='nssm:spear_' .. kind, wear=self.wear+65535/toughness})
   * 				end
   * 			elseif self.timer>0.2 then
   * 				local objs = minetest.get_objects_inside_radius({x=pos.x,y=pos.y,z=pos.z}, 1)
   * 				for k, obj in pairs(objs) do
   * 					if obj:get_luaentity() ~= nil then
   * 						if obj:get_luaentity().name ~= "nssm:spear_" .. kind .. "_entity" and obj:get_luaentity().name ~= "__builtin:item" then
   * 							local speed = vector.length(self.object:getvelocity())
   * 							local damage = (speed + eq)^1.12-20
   * 							obj:punch(self.object, 1.0, {
   * 								full_punch_interval=1.0,
   * 								damage_groups={fleshy=damage},
   * 							}, nil)
   * 							self.object:remove()
   * 							if self.wear+65535/toughness < 65535 then
   * 								minetest.add_item(self.lastpos, {name='nssm:spear_' .. kind, wear=self.wear+65535/toughness})
   * 							end
   * 						end
   * 					end
   * 				end
   * 			end
   * 		end
   * 		self.lastpos={x=pos.x, y=pos.y, z=pos.z}
   * 	end */
  lua_pushvalue(L,lc1);
  lua_pushcclosure(L,lcf1_SPEAR_ENTITY_on_step,1);
  lua_pushliteral(L,"on_step");
  lua_insert(L,-2);
  lua_settable(L,5);
  assert(lua_gettop(L) == 5);
  
  /* return SPEAR_ENTITY */
  lua_pushvalue(L,5);
  return 1;
  assert(lua_gettop(L) == 5);
}


/* function(itemstack, user, pointed_thing) */
static int lcf36 (lua_State * L) {
  enum { lc_nformalargs = 3 };
  lua_settop(L,3);
  
  /* spears_shot(itemstack, user) */
  lua_getfield(L,LUA_ENVIRONINDEX,"spears_shot");
  lua_pushvalue(L,1);
  lua_pushvalue(L,2);
  lua_call(L,2,0);
  assert(lua_gettop(L) == 3);
  
  /* if not minetest.setting_getbool("creative_mode") then */
  enum { lc34 = 3 };
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"setting_getbool");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"creative_mode");
  lua_call(L,1,1);
  lua_pushboolean(L,!(lua_toboolean(L,-1)));
  lua_remove(L,-2);
  const int lc35 = lua_toboolean(L,-1);
  lua_pop(L,1);
  if (lc35) {
    
    /* itemstack:take_item() */
    lua_pushvalue(L,1);
    lua_pushliteral(L,"take_item");
    lua_gettable(L,-2);
    lua_insert(L,-2);
    lua_call(L,1,0);
    assert(lua_gettop(L) == 3);
  }
  lua_settop(L,lc34);
  assert(lua_gettop(L) == 3);
  
  /* return itemstack */
  lua_pushvalue(L,1);
  return 1;
  assert(lua_gettop(L) == 3);
}


/* function(itemstack, user, pointed_thing) */
static int lcf39 (lua_State * L) {
  enum { lc_nformalargs = 3 };
  lua_settop(L,3);
  
  /* minetest.add_item(pointed_thing.above, itemstack) */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"add_item");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"above");
  lua_gettable(L,3);
  lua_pushvalue(L,1);
  lua_call(L,2,0);
  assert(lua_gettop(L) == 3);
  
  /* if not minetest.setting_getbool("creative_mode") then */
  enum { lc37 = 3 };
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"setting_getbool");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"creative_mode");
  lua_call(L,1,1);
  lua_pushboolean(L,!(lua_toboolean(L,-1)));
  lua_remove(L,-2);
  const int lc38 = lua_toboolean(L,-1);
  lua_pop(L,1);
  if (lc38) {
    
    /* itemstack:take_item() */
    lua_pushvalue(L,1);
    lua_pushliteral(L,"take_item");
    lua_gettable(L,-2);
    lua_insert(L,-2);
    lua_call(L,1,0);
    assert(lua_gettop(L) == 3);
  }
  lua_settop(L,lc37);
  assert(lua_gettop(L) == 3);
  
  /* return itemstack */
  lua_pushvalue(L,1);
  return 1;
  assert(lua_gettop(L) == 3);
}


/* name: spears_register_spear
 * function(kind, desc, eq, toughness, material) */
static int lcf1_spears_register_spear (lua_State * L) {
  enum { lc_nformalargs = 5 };
  lua_settop(L,5);
  
  /* minetest.register_tool("nssm:spear_" .. kind, {
   * 		description = desc .. " spear",
   *                 wield_image = "spear_" .. kind .. ".png",
   * 		inventory_image = "spear_" .. kind .. ".png^[transform4",
   * 		wield_scale= {x=2,y=1,z=1},
   * 		on_drop = function(itemstack, user, pointed_thing)
   * 			spears_shot(itemstack, user)
   * 			if not minetest.setting_getbool("creative_mode") then
   * 				itemstack:take_item()
   * 			end
   * 			return itemstack
   * 		end,
   * 		on_place = function(itemstack, user, pointed_thing)
   * 			minetest.add_item(pointed_thing.above, itemstack)
   * 			if not minetest.setting_getbool("creative_mode") then
   * 				itemstack:take_item()
   * 			end
   * 			return itemstack
   * 		end,
   * 		tool_capabilities = {
   * 			full_punch_interval = 1.3,
   * 			max_drop_level=1,
   * 			groupcaps={
   * 				snappy = {times={[3]=0.2, [2]=0.2, [1]=0.2}, uses=toughness, maxlevel=1},
   * 			},
   * 			damage_groups = {fleshy=eq},
   * 		}
   * 	}) */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"register_tool");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"nssm:spear_");
  lua_pushvalue(L,1);
  lua_concat(L,2);
  lua_createtable(L,0,7);
  lua_pushliteral(L,"description");
  lua_pushvalue(L,2);
  lua_pushliteral(L," spear");
  lua_concat(L,2);
  lua_rawset(L,-3);
  lua_pushliteral(L,"wield_image");
  lua_pushliteral(L,"spear_");
  lua_pushvalue(L,1);
  lua_pushliteral(L,".png");
  lua_concat(L,2);
  lua_concat(L,2);
  lua_rawset(L,-3);
  lua_pushliteral(L,"inventory_image");
  lua_pushliteral(L,"spear_");
  lua_pushvalue(L,1);
  lua_pushliteral(L,".png^[transform4");
  lua_concat(L,2);
  lua_concat(L,2);
  lua_rawset(L,-3);
  lua_pushliteral(L,"wield_scale");
  lua_createtable(L,0,3);
  lua_pushliteral(L,"x");
  lua_pushnumber(L,2);
  lua_rawset(L,-3);
  lua_pushliteral(L,"y");
  lua_pushnumber(L,1);
  lua_rawset(L,-3);
  lua_pushliteral(L,"z");
  lua_pushnumber(L,1);
  lua_rawset(L,-3);
  lua_rawset(L,-3);
  lua_pushliteral(L,"on_drop");
  lua_pushcfunction(L,lcf36);
  lua_rawset(L,-3);
  lua_pushliteral(L,"on_place");
  lua_pushcfunction(L,lcf39);
  lua_rawset(L,-3);
  lua_pushliteral(L,"tool_capabilities");
  lua_createtable(L,0,4);
  lua_pushliteral(L,"full_punch_interval");
  lua_pushnumber(L,1.3);
  lua_rawset(L,-3);
  lua_pushliteral(L,"max_drop_level");
  lua_pushnumber(L,1);
  lua_rawset(L,-3);
  lua_pushliteral(L,"groupcaps");
  lua_createtable(L,0,1);
  lua_pushliteral(L,"snappy");
  lua_createtable(L,0,3);
  lua_pushliteral(L,"times");
  lua_createtable(L,0,3);
  lua_pushnumber(L,3);
  lua_pushnumber(L,0.2);
  lua_rawset(L,-3);
  lua_pushnumber(L,2);
  lua_pushnumber(L,0.2);
  lua_rawset(L,-3);
  lua_pushnumber(L,1);
  lua_pushnumber(L,0.2);
  lua_rawset(L,-3);
  lua_rawset(L,-3);
  lua_pushliteral(L,"uses");
  lua_pushvalue(L,4);
  lua_rawset(L,-3);
  lua_pushliteral(L,"maxlevel");
  lua_pushnumber(L,1);
  lua_rawset(L,-3);
  lua_rawset(L,-3);
  lua_rawset(L,-3);
  lua_pushliteral(L,"damage_groups");
  lua_createtable(L,0,1);
  lua_pushliteral(L,"fleshy");
  lua_pushvalue(L,3);
  lua_rawset(L,-3);
  lua_rawset(L,-3);
  lua_rawset(L,-3);
  lua_call(L,2,0);
  assert(lua_gettop(L) == 5);
  
  /* SPEAR_ENTITY=spears_set_entity(kind, eq, toughness) */
  lua_getfield(L,LUA_ENVIRONINDEX,"spears_set_entity");
  lua_pushvalue(L,1);
  lua_pushvalue(L,3);
  lua_pushvalue(L,4);
  lua_call(L,3,1);
  lua_setfield(L,LUA_ENVIRONINDEX,"SPEAR_ENTITY");
  assert(lua_gettop(L) == 5);
  
  /* minetest.register_entity("nssm:spear_" .. kind .. "_entity", SPEAR_ENTITY) */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"register_entity");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"nssm:spear_");
  lua_pushvalue(L,1);
  lua_pushliteral(L,"_entity");
  lua_concat(L,2);
  lua_concat(L,2);
  lua_getfield(L,LUA_ENVIRONINDEX,"SPEAR_ENTITY");
  lua_call(L,2,0);
  assert(lua_gettop(L) == 5);
  
  /* minetest.register_craft({
   * 		output = 'nssm:spear_' .. kind,
   * 		recipe = {
   * 			{'group:wood', 'group:wood', material},
   * 		}
   * 	}) */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"register_craft");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_createtable(L,0,2);
  lua_pushliteral(L,"output");
  lua_pushliteral(L,"nssm:spear_");
  lua_pushvalue(L,1);
  lua_concat(L,2);
  lua_rawset(L,-3);
  lua_pushliteral(L,"recipe");
  lua_createtable(L,1,0);
  lua_createtable(L,3,0);
  lua_pushliteral(L,"group:wood");
  lua_rawseti(L,-2,1);
  lua_pushliteral(L,"group:wood");
  lua_rawseti(L,-2,2);
  lua_pushvalue(L,5);
  lua_rawseti(L,-2,3);
  lua_rawseti(L,-2,1);
  lua_rawset(L,-3);
  lua_call(L,1,0);
  assert(lua_gettop(L) == 5);
  
  /* minetest.register_craft({
   * 		output = 'nssm:spear_' .. kind,
   * 		recipe = {
   * 			{material, 'group:wood', 'group:wood'},
   * 		}
   * 	}) */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"register_craft");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_createtable(L,0,2);
  lua_pushliteral(L,"output");
  lua_pushliteral(L,"nssm:spear_");
  lua_pushvalue(L,1);
  lua_concat(L,2);
  lua_rawset(L,-3);
  lua_pushliteral(L,"recipe");
  lua_createtable(L,1,0);
  lua_createtable(L,3,0);
  lua_pushvalue(L,5);
  lua_rawseti(L,-2,1);
  lua_pushliteral(L,"group:wood");
  lua_rawseti(L,-2,2);
  lua_pushliteral(L,"group:wood");
  lua_rawseti(L,-2,3);
  lua_rawseti(L,-2,1);
  lua_rawset(L,-3);
  lua_call(L,1,0);
  assert(lua_gettop(L) == 5);
  return 0;
}


/* name: (main)
 * function(...) */
static int lcf_main (lua_State * L) {
  enum { lc_nformalargs = 0 };
  #ifndef NDEBUG
  const int lc_nactualargs = lua_gettop(L);
  #endif
  #ifndef NDEBUG
  const int lc_nextra = (lc_nactualargs - lc_nformalargs);
  #endif
  
  /* --function
   * function spears_shot (itemstack, player)
   * 	local spear = itemstack:get_name() .. '_entity'
   * 	local playerpos = player:getpos()
   * 	local obj = minetest.add_entity({x=playerpos.x,y=playerpos.y+1.5,z=playerpos.z}, spear)
   * 	local dir = player:get_look_dir()
   * 	local sp = 16
   * 	local dr = .3
   * 	local gravity = 9.8
   * 	obj:setvelocity({x=dir.x*sp, y=dir.y*sp, z=dir.z*sp})
   * 	obj:setacceleration({x=-dir.x*dr, y=-gravity, z=-dir.z*dr})
   * 	obj:setyaw(player:get_look_yaw()+math.pi)
   * 	minetest.sound_play("spears_sound", {pos=playerpos})
   * 	obj:get_luaentity().wear = itemstack:get_wear()
   * 	return true
   * end */
  lua_pushcfunction(L,lcf1_spears_shot);
  lua_setfield(L,LUA_ENVIRONINDEX,"spears_shot");
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* function spears_set_entity(kind, eq, toughness)
   * 	local SPEAR_ENTITY={
   * 		physical = false,
   * 		timer=0,
   * 		visual = "wielditem",
   * 		visual_size = {x=0.15, y=0.1},
   * 		textures = {"nssm:spear_" .. kind},
   * 		lastpos={},
   * 		collisionbox = {0,0,0,0,0,0},
   * 		on_punch = function(self, puncher)
   * 			if puncher then
   * 				if puncher:is_player() then
   * 					local stack = {name='nssm:spear_' .. kind, wear=self.wear+65535/toughness}
   * 					local inv = puncher:get_inventory()
   * 					if inv:room_for_item("main", stack) then
   * 						inv:add_item("main", stack)
   * 						self.object:remove()
   * 					end
   * 				end
   * 			end
   * 		end,
   * 	}
   * 	
   * 	SPEAR_ENTITY.on_step = function(self, dtime)
   * 		self.timer=self.timer+dtime
   * 		local pos = self.object:getpos()
   * 		local node = minetest.get_node(pos)
   * 		if not self.wear then
   * 			self.object:remove()
   * 			return
   * 		end
   * 		if self.lastpos.x~=nil then
   * 			if node.name ~= "air" and not (string.find(node.name, 'grass') and not string.find(node.name, 'dirt')) and not string.find(node.name, 'flowers:') and not string.find(node.name, 'farming:') then
   * 				self.object:remove()
   * 				if self.wear+65535/toughness < 65535 then
   * 					minetest.add_item(self.lastpos, {name='nssm:spear_' .. kind, wear=self.wear+65535/toughness})
   * 				end
   * 			elseif self.timer>0.2 then
   * 				local objs = minetest.get_objects_inside_radius({x=pos.x,y=pos.y,z=pos.z}, 1)
   * 				for k, obj in pairs(objs) do
   * 					if obj:get_luaentity() ~= nil then
   * 						if obj:get_luaentity().name ~= "nssm:spear_" .. kind .. "_entity" and obj:get_luaentity().name ~= "__builtin:item" then
   * 							local speed = vector.length(self.object:getvelocity())
   * 							local damage = (speed + eq)^1.12-20
   * 							obj:punch(self.object, 1.0, {
   * 								full_punch_interval=1.0,
   * 								damage_groups={fleshy=damage},
   * 							}, nil)
   * 							self.object:remove()
   * 							if self.wear+65535/toughness < 65535 then
   * 								minetest.add_item(self.lastpos, {name='nssm:spear_' .. kind, wear=self.wear+65535/toughness})
   * 							end
   * 						end
   * 					end
   * 				end
   * 			end
   * 		end
   * 		self.lastpos={x=pos.x, y=pos.y, z=pos.z}
   * 	end
   * 	return SPEAR_ENTITY
   * end */
  lua_pushcfunction(L,lcf1_spears_set_entity);
  lua_setfield(L,LUA_ENVIRONINDEX,"spears_set_entity");
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* --Tools
   * function spears_register_spear(kind, desc, eq, toughness, material)
   * 
   * 	minetest.register_tool("nssm:spear_" .. kind, {
   * 		description = desc .. " spear",
   *                 wield_image = "spear_" .. kind .. ".png",
   * 		inventory_image = "spear_" .. kind .. ".png^[transform4",
   * 		wield_scale= {x=2,y=1,z=1},
   * 		on_drop = function(itemstack, user, pointed_thing)
   * 			spears_shot(itemstack, user)
   * 			if not minetest.setting_getbool("creative_mode") then
   * 				itemstack:take_item()
   * 			end
   * 			return itemstack
   * 		end,
   * 		on_place = function(itemstack, user, pointed_thing)
   * 			minetest.add_item(pointed_thing.above, itemstack)
   * 			if not minetest.setting_getbool("creative_mode") then
   * 				itemstack:take_item()
   * 			end
   * 			return itemstack
   * 		end,
   * 		tool_capabilities = {
   * 			full_punch_interval = 1.3,
   * 			max_drop_level=1,
   * 			groupcaps={
   * 				snappy = {times={[3]=0.2, [2]=0.2, [1]=0.2}, uses=toughness, maxlevel=1},
   * 			},
   * 			damage_groups = {fleshy=eq},
   * 		}
   * 	})
   * 	
   * 	SPEAR_ENTITY=spears_set_entity(kind, eq, toughness)
   * 	
   * 	minetest.register_entity("nssm:spear_" .. kind .. "_entity", SPEAR_ENTITY)
   * 	
   * 	minetest.register_craft({
   * 		output = 'nssm:spear_' .. kind,
   * 		recipe = {
   * 			{'group:wood', 'group:wood', material},
   * 		}
   * 	})
   * 	
   * 	minetest.register_craft({
   * 		output = 'nssm:spear_' .. kind,
   * 		recipe = {
   * 			{material, 'group:wood', 'group:wood'},
   * 		}
   * 	})
   * end */
  lua_pushcfunction(L,lcf1_spears_register_spear);
  lua_setfield(L,LUA_ENVIRONINDEX,"spears_register_spear");
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* spears_register_spear('ant', 'Ant', 6, 25, 'nssm:ant_mandible') */
  lua_getfield(L,LUA_ENVIRONINDEX,"spears_register_spear");
  lua_pushliteral(L,"ant");
  lua_pushliteral(L,"Ant");
  lua_pushnumber(L,6);
  lua_pushnumber(L,25);
  lua_pushliteral(L,"nssm:ant_mandible");
  lua_call(L,5,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* spears_register_spear('mantis', 'Mantis', 6, 10, 'nssm:mantis_claw') */
  lua_getfield(L,LUA_ENVIRONINDEX,"spears_register_spear");
  lua_pushliteral(L,"mantis");
  lua_pushliteral(L,"Mantis");
  lua_pushnumber(L,6);
  lua_pushnumber(L,10);
  lua_pushliteral(L,"nssm:mantis_claw");
  lua_call(L,5,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* spears_register_spear('manticore', 'Manticore', 8, 8, 'nssm:manticore_spine') */
  lua_getfield(L,LUA_ENVIRONINDEX,"spears_register_spear");
  lua_pushliteral(L,"manticore");
  lua_pushliteral(L,"Manticore");
  lua_pushnumber(L,8);
  lua_pushnumber(L,8);
  lua_pushliteral(L,"nssm:manticore_spine");
  lua_call(L,5,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* spears_register_spear('ice_tooth', 'Ice Tooth', 16, 200, 'nssm:ice_tooth') */
  lua_getfield(L,LUA_ENVIRONINDEX,"spears_register_spear");
  lua_pushliteral(L,"ice_tooth");
  lua_pushliteral(L,"Ice Tooth");
  lua_pushnumber(L,16);
  lua_pushnumber(L,200);
  lua_pushliteral(L,"nssm:ice_tooth");
  lua_call(L,5,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* spears_register_spear('little_ice_tooth', 'Little Ice Tooth', 7, 10, 'nssm:little_ice_tooth') */
  lua_getfield(L,LUA_ENVIRONINDEX,"spears_register_spear");
  lua_pushliteral(L,"little_ice_tooth");
  lua_pushliteral(L,"Little Ice Tooth");
  lua_pushnumber(L,7);
  lua_pushnumber(L,10);
  lua_pushliteral(L,"nssm:little_ice_tooth");
  lua_call(L,5,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* spears_register_spear('duck_beak', 'Duck Beak', 5, 6, 'nssm:duck_beak') */
  lua_getfield(L,LUA_ENVIRONINDEX,"spears_register_spear");
  lua_pushliteral(L,"duck_beak");
  lua_pushliteral(L,"Duck Beak");
  lua_pushnumber(L,5);
  lua_pushnumber(L,6);
  lua_pushliteral(L,"nssm:duck_beak");
  lua_call(L,5,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  return 0;
}


/* from lua.c */
static int traceback (lua_State *L) {
  if (!lua_isstring(L, 1))  /* 'message' not a string? */
    return 1;  /* keep it intact */
  lua_getfield(L, LUA_GLOBALSINDEX, "debug");
  if (!lua_istable(L, -1)) {
    lua_pop(L, 1);
    return 1;
  }
  lua_getfield(L, -1, "traceback");
  if (!lua_isfunction(L, -1)) {
    lua_pop(L, 2);
    return 1;
  }
  lua_pushvalue(L, 1);  /* pass error message */
  lua_pushinteger(L, 2);  /* skip this function and traceback */
  lua_call(L, 2, 1);  /* call debug.traceback */
  return 1;
}


static void lc_l_message (const char *pname, const char *msg) {
  if (pname) fprintf(stderr, "%s: ", pname);
  fprintf(stderr, "%s\n", msg);
  fflush(stderr);
}

static int lc_report (lua_State *L, int status) {
  if (status && !lua_isnil(L, -1)) {
    const char *msg = lua_tostring(L, -1);
    if (msg == NULL) msg = "(error object is not a string)";
    /*FIX-IMROVE:progname*/
    lc_l_message("lua", msg);
    lua_pop(L, 1);
  }
  return status;
}

static int lc_docall (lua_State *L, int narg, int clear) {
  int status;
  int base = lua_gettop(L) - narg;  /* function index */
  lua_pushcfunction(L, traceback);  /* push traceback function */
  lua_insert(L, base);  /* put it under chunk and args */
  /*FIX? signal(SIGINT, laction); */
  status = lua_pcall(L, narg, (clear ? 0 : LUA_MULTRET), base);
  /*FIX? signal(SIGINT, SIG_DFL); */
  lua_remove(L, base);  /* remove traceback function */
  /* force a complete garbage collection in case of errors */
  if (status != 0) lua_gc(L, LUA_GCCOLLECT, 0);
  return status;
}

static int lc_dofile (lua_State *L, const char *name) {
  int status = luaL_loadfile(L, name) || lc_docall(L, 0, 1);
  return lc_report(L, status);
}

static int lc_dostring (lua_State *L, const char *s, const char *name) {
  int status = luaL_loadbuffer(L, s, strlen(s), name) || lc_docall(L, 0, 1);
  return lc_report(L, status);
}

static int lc_handle_luainit (lua_State *L) {
  const char *init = getenv(LUA_INIT);
  if (init == NULL) return 0;  /* status OK */
  else if (init[0] == '@')
    return lc_dofile(L, init+1);
  else
    return lc_dostring(L, init, "=" LUA_INIT);
}


typedef struct {
  int c;
  const char ** v;
} lc_args_t;


/* create global arg table */
static void lc_createarg(lua_State * L, const lc_args_t * const args) {
  int i;
  lua_newtable(L);
  for (i=0; i < args->c; i++) {
    lua_pushstring(L, args->v[i]);
    lua_rawseti(L, -2, i);
  }
  lua_setglobal(L, "arg");
}


int lc_pmain_mod_nssm_nssm_spears(lua_State * L) {
  luaL_openlibs(L);

  lua_pushcfunction(L, traceback);

  const int status1 = lc_handle_luainit(L);
  if (status1 != 0) return 0;

  /* note: IMPROVE: closure not always needed here */
  lua_newtable(L); /* closure table */
  lua_pushcclosure(L, lcf_main, 1);

  int status2 = lua_pcall(L, 0, 0, -2);
  if (status2 != 0) {
    const char * msg = lua_tostring(L,-1);
    if (msg == NULL) msg = "(error object is not a string)";
    fputs(msg, stderr);
  }
  return 0;
}


