/* WARNING: This file was automatically generated by lua2c. */

#ifdef __cplusplus
extern "C" {
#endif
#include <lua.h>
#include <lauxlib.h>
#include <lualib.h>
#ifdef __cplusplus
}
#endif
#include <stdio.h>
#include <stdlib.h>


#include <string.h>


#include <assert.h>

/* __sub metamethod handler.
 * warning: assumes indices in range LUA_REGISTRYINDEX < x < 0 are relative. */
static void lc_sub(lua_State * L, int idxa, int idxb) {
  if (lua_isnumber(L,idxa) && lua_isnumber(L,idxb)) {
    lua_pushnumber(L,lua_tonumber(L,idxa) - lua_tonumber(L,idxb));
  }
  else {
    if (luaL_getmetafield(L,idxa,"__sub")||luaL_getmetafield(L,idxb,"__sub")) {
      lua_pushvalue(L,idxa < 0 && idxa > LUA_REGISTRYINDEX ? idxa-1 : idxa);
      lua_pushvalue(L,idxb < 0 && idxb > LUA_REGISTRYINDEX ? idxb-2 : idxb);
      lua_call(L,2,1);
    }
    else {
      luaL_error(L, "attempt to perform arithmetic");
    }
  }
}


/* name: namegen.generate_village_name
 * function( pr) */
static int lcf1_namegen_generate_village_name (lua_State * L) {
  enum { lc_nformalargs = 1 };
  lua_settop(L,1);
  
  /* local anz_silben = pr:next(2,5) */
  lua_pushvalue(L,1);
  lua_pushliteral(L,"next");
  lua_gettable(L,-2);
  lua_insert(L,-2);
  lua_pushnumber(L,2);
  lua_pushnumber(L,5);
  lua_call(L,3,1);
  assert(lua_gettop(L) == 2);
  
  /* local name = '' */
  lua_pushliteral(L,"");
  assert(lua_gettop(L) == 3);
  
  /* local prefix  = '' */
  lua_pushliteral(L,"");
  assert(lua_gettop(L) == 4);
  
  /* local postfix = '' */
  lua_pushliteral(L,"");
  assert(lua_gettop(L) == 5);
  
  /* if( pr:next(1,8)==1) then */
  enum { lc1 = 5 };
  lua_pushvalue(L,1);
  lua_pushliteral(L,"next");
  lua_gettable(L,-2);
  lua_insert(L,-2);
  lua_pushnumber(L,1);
  lua_pushnumber(L,8);
  lua_call(L,3,1);
  lua_pushnumber(L,1);
  const int lc2 = lua_equal(L,-2,-1);
  lua_pop(L,2);
  lua_pushboolean(L,lc2);
  const int lc3 = lua_toboolean(L,-1);
  lua_pop(L,1);
  if (lc3) {
    
    /* prefix = namegen.prefixes[ #namegen.prefixes ] */
    lua_getfield(L,LUA_ENVIRONINDEX,"namegen");
    lua_pushliteral(L,"prefixes");
    lua_gettable(L,-2);
    lua_remove(L,-2);
    lua_getfield(L,LUA_ENVIRONINDEX,"namegen");
    lua_pushliteral(L,"prefixes");
    lua_gettable(L,-2);
    lua_remove(L,-2);
    const double lc4 = lua_objlen(L,-1);
    lua_pop(L,1);
    lua_pushnumber(L,lc4);
    lua_gettable(L,-2);
    lua_remove(L,-2);
    lua_replace(L,4);
    assert(lua_gettop(L) == 5);
    
    /* anz_silben = anz_silben -1 */
    lua_pushnumber(L,1);
    lc_sub(L,2,-1);
    lua_remove(L,-2);
    lua_replace(L,2);
    assert(lua_gettop(L) == 5);
  }
  lua_settop(L,lc1);
  assert(lua_gettop(L) == 5);
  
  /* if( pr:next(1,4)==1) then */
  enum { lc5 = 5 };
  lua_pushvalue(L,1);
  lua_pushliteral(L,"next");
  lua_gettable(L,-2);
  lua_insert(L,-2);
  lua_pushnumber(L,1);
  lua_pushnumber(L,4);
  lua_call(L,3,1);
  lua_pushnumber(L,1);
  const int lc6 = lua_equal(L,-2,-1);
  lua_pop(L,2);
  lua_pushboolean(L,lc6);
  const int lc7 = lua_toboolean(L,-1);
  lua_pop(L,1);
  if (lc7) {
    
    /* postfix = name..namegen.suffixes[ #namegen.suffixes ] */
    lua_pushvalue(L,3);
    lua_getfield(L,LUA_ENVIRONINDEX,"namegen");
    lua_pushliteral(L,"suffixes");
    lua_gettable(L,-2);
    lua_remove(L,-2);
    lua_getfield(L,LUA_ENVIRONINDEX,"namegen");
    lua_pushliteral(L,"suffixes");
    lua_gettable(L,-2);
    lua_remove(L,-2);
    const double lc8 = lua_objlen(L,-1);
    lua_pop(L,1);
    lua_pushnumber(L,lc8);
    lua_gettable(L,-2);
    lua_remove(L,-2);
    lua_concat(L,2);
    lua_replace(L,5);
    assert(lua_gettop(L) == 5);
    
    /* anz_silben = anz_silben -2 */
    lua_pushnumber(L,2);
    lc_sub(L,2,-1);
    lua_remove(L,-2);
    lua_replace(L,2);
    assert(lua_gettop(L) == 5);
  }
  lua_settop(L,lc5);
  assert(lua_gettop(L) == 5);
  
  /* if( anz_silben < 2 ) then */
  enum { lc9 = 5 };
  lua_pushnumber(L,2);
  const int lc10 = lua_lessthan(L,2,-1);
  lua_pop(L,1);
  lua_pushboolean(L,lc10);
  const int lc11 = lua_toboolean(L,-1);
  lua_pop(L,1);
  if (lc11) {
    
    /* anz_silben = 2 */
    lua_pushnumber(L,2);
    lua_replace(L,2);
    assert(lua_gettop(L) == 5);
  }
  lua_settop(L,lc9);
  assert(lua_gettop(L) == 5);
  
  /* for i = 1, anz_silben do */
  lua_pushnumber(L,1);
  if (!((lua_isnumber(L,-1) && lua_isnumber(L,2)))) {
    luaL_error(L,"'for' limit must be a number");
  }
  double lc12_var = lua_tonumber(L,-1);
  const double lc13_limit = lua_tonumber(L,2);
  const double lc14_step = 1;
  lua_pop(L,1);
  enum { lc15 = 5 };
  while ((((lc14_step > 0) && (lc12_var <= lc13_limit)) || ((lc14_step <= 0) && (lc12_var >= lc13_limit)))) {
    
    /* internal: local i at index 6 */
    lua_pushnumber(L,lc12_var);
    
    /* name = name..namegen.silben[ pr:next( 1, #namegen.silben )] */
    lua_pushvalue(L,3);
    lua_getfield(L,LUA_ENVIRONINDEX,"namegen");
    lua_pushliteral(L,"silben");
    lua_gettable(L,-2);
    lua_remove(L,-2);
    lua_pushvalue(L,1);
    lua_pushliteral(L,"next");
    lua_gettable(L,-2);
    lua_insert(L,-2);
    lua_pushnumber(L,1);
    lua_getfield(L,LUA_ENVIRONINDEX,"namegen");
    lua_pushliteral(L,"silben");
    lua_gettable(L,-2);
    lua_remove(L,-2);
    const double lc16 = lua_objlen(L,-1);
    lua_pop(L,1);
    lua_pushnumber(L,lc16);
    lua_call(L,3,1);
    lua_gettable(L,-2);
    lua_remove(L,-2);
    lua_concat(L,2);
    lua_replace(L,3);
    assert(lua_gettop(L) == 6);
    
    /* internal: stack cleanup on scope exit */
    lua_pop(L,1);
    lc12_var += lc14_step;
  }
  lua_settop(L,lc15);
  assert(lua_gettop(L) == 5);
  
  /* name = prefix..name..postfix */
  lua_pushvalue(L,4);
  lua_pushvalue(L,3);
  lua_pushvalue(L,5);
  lua_concat(L,2);
  lua_concat(L,2);
  lua_replace(L,3);
  assert(lua_gettop(L) == 5);
  
  /* name = string.upper( string.sub( name, 1, 1 ) )..string.sub( name, 2 ) */
  lua_getfield(L,LUA_ENVIRONINDEX,"string");
  lua_pushliteral(L,"upper");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  const int lc17 = lua_gettop(L);
  lua_getfield(L,LUA_ENVIRONINDEX,"string");
  lua_pushliteral(L,"sub");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushvalue(L,3);
  lua_pushnumber(L,1);
  lua_pushnumber(L,1);
  lua_call(L,3,LUA_MULTRET);
  lua_call(L,(lua_gettop(L) - lc17),1);
  lua_getfield(L,LUA_ENVIRONINDEX,"string");
  lua_pushliteral(L,"sub");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushvalue(L,3);
  lua_pushnumber(L,2);
  lua_call(L,2,1);
  lua_concat(L,2);
  lua_replace(L,3);
  assert(lua_gettop(L) == 5);
  
  /* return name */
  lua_pushvalue(L,3);
  return 1;
  assert(lua_gettop(L) == 5);
}


/* name: namegen.generate_village_name_with_prefix
 * function( pr, village) */
static int lcf1_namegen_generate_village_name_with_prefix (lua_State * L) {
  enum { lc_nformalargs = 2 };
  lua_settop(L,2);
  
  /* local name = namegen.generate_village_name( pr ) */
  lua_getfield(L,LUA_ENVIRONINDEX,"namegen");
  lua_pushliteral(L,"generate_village_name");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushvalue(L,1);
  lua_call(L,1,1);
  assert(lua_gettop(L) == 3);
  
  /* -- if a village consists of a single house, it gets a prefix depending on the house type
   * if( village.is_single_house and village.to_add_data and village.to_add_data.bpos ) then */
  enum { lc18 = 3 };
  lua_pushliteral(L,"is_single_house");
  lua_gettable(L,2);
  if (lua_toboolean(L,-1)) {
    lua_pop(L,1);
    lua_pushliteral(L,"to_add_data");
    lua_gettable(L,2);
  }
  if (lua_toboolean(L,-1)) {
    lua_pop(L,1);
    lua_pushliteral(L,"to_add_data");
    lua_gettable(L,2);
    lua_pushliteral(L,"bpos");
    lua_gettable(L,-2);
    lua_remove(L,-2);
  }
  const int lc19 = lua_toboolean(L,-1);
  lua_pop(L,1);
  if (lc19) {
    
    /* -- the building got removed from mg_villages.BUILDINGS in the meantime
     * if( not( mg_villages.BUILDINGS[ village.to_add_data.bpos[1].btype] )) then */
    enum { lc20 = 3 };
    lua_getfield(L,LUA_ENVIRONINDEX,"mg_villages");
    lua_pushliteral(L,"BUILDINGS");
    lua_gettable(L,-2);
    lua_remove(L,-2);
    lua_pushliteral(L,"to_add_data");
    lua_gettable(L,2);
    lua_pushliteral(L,"bpos");
    lua_gettable(L,-2);
    lua_remove(L,-2);
    lua_pushnumber(L,1);
    lua_gettable(L,-2);
    lua_remove(L,-2);
    lua_pushliteral(L,"btype");
    lua_gettable(L,-2);
    lua_remove(L,-2);
    lua_gettable(L,-2);
    lua_remove(L,-2);
    lua_pushboolean(L,!(lua_toboolean(L,-1)));
    lua_remove(L,-2);
    const int lc21 = lua_toboolean(L,-1);
    lua_pop(L,1);
    if (lc21) {
      
      /* return 'Abandomed building' */
      lua_pushliteral(L,"Abandomed building");
      return 1;
      assert(lua_gettop(L) == 3);
    }
    lua_settop(L,lc20);
    assert(lua_gettop(L) == 3);
    
    /* local btyp = mg_villages.BUILDINGS[ village.to_add_data.bpos[1].btype].typ */
    lua_getfield(L,LUA_ENVIRONINDEX,"mg_villages");
    lua_pushliteral(L,"BUILDINGS");
    lua_gettable(L,-2);
    lua_remove(L,-2);
    lua_pushliteral(L,"to_add_data");
    lua_gettable(L,2);
    lua_pushliteral(L,"bpos");
    lua_gettable(L,-2);
    lua_remove(L,-2);
    lua_pushnumber(L,1);
    lua_gettable(L,-2);
    lua_remove(L,-2);
    lua_pushliteral(L,"btype");
    lua_gettable(L,-2);
    lua_remove(L,-2);
    lua_gettable(L,-2);
    lua_remove(L,-2);
    lua_pushliteral(L,"typ");
    lua_gettable(L,-2);
    lua_remove(L,-2);
    assert(lua_gettop(L) == 4);
    
    /* local bdata = mg_villages.village_type_data[ btyp ] */
    lua_getfield(L,LUA_ENVIRONINDEX,"mg_villages");
    lua_pushliteral(L,"village_type_data");
    lua_gettable(L,-2);
    lua_remove(L,-2);
    lua_pushvalue(L,4);
    lua_gettable(L,-2);
    lua_remove(L,-2);
    assert(lua_gettop(L) == 5);
    
    /* if( bdata and (bdata.name_prefix or bdata.name_postfix )) then */
    enum { lc22 = 5 };
    lua_pushvalue(L,5);
    if (lua_toboolean(L,-1)) {
      lua_pop(L,1);
      lua_pushliteral(L,"name_prefix");
      lua_gettable(L,5);
      if (!(lua_toboolean(L,-1))) {
        lua_pop(L,1);
        lua_pushliteral(L,"name_postfix");
        lua_gettable(L,5);
      }
    }
    const int lc23 = lua_toboolean(L,-1);
    lua_pop(L,1);
    if (lc23) {
      
      /* name = (bdata.name_prefix or '')..name..(bdata.name_postfix or '') */
      lua_pushliteral(L,"name_prefix");
      lua_gettable(L,5);
      if (!(lua_toboolean(L,-1))) {
        lua_pop(L,1);
        lua_pushliteral(L,"");
      }
      lua_pushvalue(L,3);
      lua_pushliteral(L,"name_postfix");
      lua_gettable(L,5);
      if (!(lua_toboolean(L,-1))) {
        lua_pop(L,1);
        lua_pushliteral(L,"");
      }
      lua_concat(L,2);
      lua_concat(L,2);
      lua_replace(L,3);
      assert(lua_gettop(L) == 5);
    }
    else {
      
      /* else
       * name = 'House '..name */
      lua_pushliteral(L,"House ");
      lua_pushvalue(L,3);
      lua_concat(L,2);
      lua_replace(L,3);
      assert(lua_gettop(L) == 5);
    }
    lua_settop(L,lc22);
    assert(lua_gettop(L) == 5);
  }
  lua_settop(L,lc18);
  assert(lua_gettop(L) == 3);
  
  /* return name */
  lua_pushvalue(L,3);
  return 1;
  assert(lua_gettop(L) == 3);
}


/* name: (main)
 * function(...) */
static int lcf_main (lua_State * L) {
  enum { lc_nformalargs = 0 };
  #ifndef NDEBUG
  const int lc_nactualargs = lua_gettop(L);
  #endif
  #ifndef NDEBUG
  const int lc_nextra = (lc_nactualargs - lc_nformalargs);
  #endif
  
  /* namegen = {} */
  lua_newtable(L);
  lua_setfield(L,LUA_ENVIRONINDEX,"namegen");
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* namegen.prefixes = {'ac','ast','lang','pen','shep','ship'} */
  lua_createtable(L,6,0);
  lua_pushliteral(L,"ac");
  lua_rawseti(L,-2,1);
  lua_pushliteral(L,"ast");
  lua_rawseti(L,-2,2);
  lua_pushliteral(L,"lang");
  lua_rawseti(L,-2,3);
  lua_pushliteral(L,"pen");
  lua_rawseti(L,-2,4);
  lua_pushliteral(L,"shep");
  lua_rawseti(L,-2,5);
  lua_pushliteral(L,"ship");
  lua_rawseti(L,-2,6);
  lua_getfield(L,LUA_ENVIRONINDEX,"namegen");
  lua_insert(L,-2);
  lua_pushliteral(L,"prefixes");
  lua_insert(L,-2);
  lua_settable(L,-3);
  lua_pop(L,1);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* namegen.suffixes = {'beck','ey','ay','bury','burgh','brough','by','by','caster',
   * 	'cester','cum','den','don','field','firth','ford','ham','ham','ham',
   * 	'hope','ing','kirk','hill','law','leigh','mouth','ness','pool','shaw',
   * 	'stead','ster','tun','ton','ton','ton','ton','wold','worth','worthy',
   * 	'ville','river','forrest','lake'} */
  lua_createtable(L,43,0);
  lua_pushliteral(L,"beck");
  lua_rawseti(L,-2,1);
  lua_pushliteral(L,"ey");
  lua_rawseti(L,-2,2);
  lua_pushliteral(L,"ay");
  lua_rawseti(L,-2,3);
  lua_pushliteral(L,"bury");
  lua_rawseti(L,-2,4);
  lua_pushliteral(L,"burgh");
  lua_rawseti(L,-2,5);
  lua_pushliteral(L,"brough");
  lua_rawseti(L,-2,6);
  lua_pushliteral(L,"by");
  lua_rawseti(L,-2,7);
  lua_pushliteral(L,"by");
  lua_rawseti(L,-2,8);
  lua_pushliteral(L,"caster");
  lua_rawseti(L,-2,9);
  lua_pushliteral(L,"cester");
  lua_rawseti(L,-2,10);
  lua_pushliteral(L,"cum");
  lua_rawseti(L,-2,11);
  lua_pushliteral(L,"den");
  lua_rawseti(L,-2,12);
  lua_pushliteral(L,"don");
  lua_rawseti(L,-2,13);
  lua_pushliteral(L,"field");
  lua_rawseti(L,-2,14);
  lua_pushliteral(L,"firth");
  lua_rawseti(L,-2,15);
  lua_pushliteral(L,"ford");
  lua_rawseti(L,-2,16);
  lua_pushliteral(L,"ham");
  lua_rawseti(L,-2,17);
  lua_pushliteral(L,"ham");
  lua_rawseti(L,-2,18);
  lua_pushliteral(L,"ham");
  lua_rawseti(L,-2,19);
  lua_pushliteral(L,"hope");
  lua_rawseti(L,-2,20);
  lua_pushliteral(L,"ing");
  lua_rawseti(L,-2,21);
  lua_pushliteral(L,"kirk");
  lua_rawseti(L,-2,22);
  lua_pushliteral(L,"hill");
  lua_rawseti(L,-2,23);
  lua_pushliteral(L,"law");
  lua_rawseti(L,-2,24);
  lua_pushliteral(L,"leigh");
  lua_rawseti(L,-2,25);
  lua_pushliteral(L,"mouth");
  lua_rawseti(L,-2,26);
  lua_pushliteral(L,"ness");
  lua_rawseti(L,-2,27);
  lua_pushliteral(L,"pool");
  lua_rawseti(L,-2,28);
  lua_pushliteral(L,"shaw");
  lua_rawseti(L,-2,29);
  lua_pushliteral(L,"stead");
  lua_rawseti(L,-2,30);
  lua_pushliteral(L,"ster");
  lua_rawseti(L,-2,31);
  lua_pushliteral(L,"tun");
  lua_rawseti(L,-2,32);
  lua_pushliteral(L,"ton");
  lua_rawseti(L,-2,33);
  lua_pushliteral(L,"ton");
  lua_rawseti(L,-2,34);
  lua_pushliteral(L,"ton");
  lua_rawseti(L,-2,35);
  lua_pushliteral(L,"ton");
  lua_rawseti(L,-2,36);
  lua_pushliteral(L,"wold");
  lua_rawseti(L,-2,37);
  lua_pushliteral(L,"worth");
  lua_rawseti(L,-2,38);
  lua_pushliteral(L,"worthy");
  lua_rawseti(L,-2,39);
  lua_pushliteral(L,"ville");
  lua_rawseti(L,-2,40);
  lua_pushliteral(L,"river");
  lua_rawseti(L,-2,41);
  lua_pushliteral(L,"forrest");
  lua_rawseti(L,-2,42);
  lua_pushliteral(L,"lake");
  lua_rawseti(L,-2,43);
  lua_getfield(L,LUA_ENVIRONINDEX,"namegen");
  lua_insert(L,-2);
  lua_pushliteral(L,"suffixes");
  lua_insert(L,-2);
  lua_settable(L,-3);
  lua_pop(L,1);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* -- people/environmental features
   * namegen.silben = { 'a', 'an', 'ab', 'ac', 'am', 
   * 	'be', 'ba', 'bi', 'bl', 'bm', 'bn', 'bo', 'br', 'bst', 'bu', 
   * 	'ca', 'ce', 'ch', 'ci', 'ck', 'cl', 'cm', 'cn', 'co', 'cv', 
   * 	'da', 'de', 'df', 'di', 'dl', 'dm', 'dn', 'do', 'dr', 'ds', 'dt', 'du', 'dv',
   * 	'do','ren','nav','ben','ada','min','org','san','pa','re','ne','en','er','ich',
   * 	'the','and','tha','ent','ing','ion','tio','for','nde',
   * 	'has','nce','edt','tis','oft','sth','mem',
   * 	'ich','ein','und','der','nde','sch','die','den','end','cht',
   * 	'the','and','tha','ent','ing','ion','for','de',
   * 	'has','ce','ed','is','ft','sth','mem',
   * 	'ch','ei','un','der','ie','den','end',
   * 	'do','ren','nav','ben','ada','min','org','san','pa','re','ne','en','er','ich',
   * 	'ta','bek','nik','le','lan','nem',
   * 	'bal','cir','da','en','fan','fir','fern','fa','oak','nut','gen','ga','hu','hi','hal',
   * 	'in','ig','ir','im','ja','je','jo','kla','kon','ker','log','lag','leg','lil',
   * 	'lon','las','leve','lere','mes','mir','mon','mm','mer','mig',	
   * 	'na','nn','nerv','neu','oto','on','opt','oll','ome','ott',
   * 	'pen','par','pi','pa','po','pel','pig','qu','ren','rig','raf','res','ring',
   * 	'rib','rast','rost','ru','rum','rem','sem','sim','su','spring',
   * 	'cotton','cot','wood','palm',
   * 	'do','na','ik','ke','gen','bra','bn','lla','lle','st','aa','kir',
   * 	'nn','en','fo','fn','gi','ja','jn','ke','kr','kon','lis','on','ok','or','op',
   * 	'pp','p','qu','re','ra','rn','ri','so','sn','se','ti','tu',
   * 	'a','e','i','o','u',
   * 	're','ro','pe','pn','ci','co','cl',
   * 	'no','en','wi','we','er','en','ba','ki','nn','va','wu','x','tel','or',
   * 	'so','me','mi','em','en','eg','ge','kn'} */
  lua_createtable(L,269,0);
  lua_pushliteral(L,"a");
  lua_rawseti(L,-2,1);
  lua_pushliteral(L,"an");
  lua_rawseti(L,-2,2);
  lua_pushliteral(L,"ab");
  lua_rawseti(L,-2,3);
  lua_pushliteral(L,"ac");
  lua_rawseti(L,-2,4);
  lua_pushliteral(L,"am");
  lua_rawseti(L,-2,5);
  lua_pushliteral(L,"be");
  lua_rawseti(L,-2,6);
  lua_pushliteral(L,"ba");
  lua_rawseti(L,-2,7);
  lua_pushliteral(L,"bi");
  lua_rawseti(L,-2,8);
  lua_pushliteral(L,"bl");
  lua_rawseti(L,-2,9);
  lua_pushliteral(L,"bm");
  lua_rawseti(L,-2,10);
  lua_pushliteral(L,"bn");
  lua_rawseti(L,-2,11);
  lua_pushliteral(L,"bo");
  lua_rawseti(L,-2,12);
  lua_pushliteral(L,"br");
  lua_rawseti(L,-2,13);
  lua_pushliteral(L,"bst");
  lua_rawseti(L,-2,14);
  lua_pushliteral(L,"bu");
  lua_rawseti(L,-2,15);
  lua_pushliteral(L,"ca");
  lua_rawseti(L,-2,16);
  lua_pushliteral(L,"ce");
  lua_rawseti(L,-2,17);
  lua_pushliteral(L,"ch");
  lua_rawseti(L,-2,18);
  lua_pushliteral(L,"ci");
  lua_rawseti(L,-2,19);
  lua_pushliteral(L,"ck");
  lua_rawseti(L,-2,20);
  lua_pushliteral(L,"cl");
  lua_rawseti(L,-2,21);
  lua_pushliteral(L,"cm");
  lua_rawseti(L,-2,22);
  lua_pushliteral(L,"cn");
  lua_rawseti(L,-2,23);
  lua_pushliteral(L,"co");
  lua_rawseti(L,-2,24);
  lua_pushliteral(L,"cv");
  lua_rawseti(L,-2,25);
  lua_pushliteral(L,"da");
  lua_rawseti(L,-2,26);
  lua_pushliteral(L,"de");
  lua_rawseti(L,-2,27);
  lua_pushliteral(L,"df");
  lua_rawseti(L,-2,28);
  lua_pushliteral(L,"di");
  lua_rawseti(L,-2,29);
  lua_pushliteral(L,"dl");
  lua_rawseti(L,-2,30);
  lua_pushliteral(L,"dm");
  lua_rawseti(L,-2,31);
  lua_pushliteral(L,"dn");
  lua_rawseti(L,-2,32);
  lua_pushliteral(L,"do");
  lua_rawseti(L,-2,33);
  lua_pushliteral(L,"dr");
  lua_rawseti(L,-2,34);
  lua_pushliteral(L,"ds");
  lua_rawseti(L,-2,35);
  lua_pushliteral(L,"dt");
  lua_rawseti(L,-2,36);
  lua_pushliteral(L,"du");
  lua_rawseti(L,-2,37);
  lua_pushliteral(L,"dv");
  lua_rawseti(L,-2,38);
  lua_pushliteral(L,"do");
  lua_rawseti(L,-2,39);
  lua_pushliteral(L,"ren");
  lua_rawseti(L,-2,40);
  lua_pushliteral(L,"nav");
  lua_rawseti(L,-2,41);
  lua_pushliteral(L,"ben");
  lua_rawseti(L,-2,42);
  lua_pushliteral(L,"ada");
  lua_rawseti(L,-2,43);
  lua_pushliteral(L,"min");
  lua_rawseti(L,-2,44);
  lua_pushliteral(L,"org");
  lua_rawseti(L,-2,45);
  lua_pushliteral(L,"san");
  lua_rawseti(L,-2,46);
  lua_pushliteral(L,"pa");
  lua_rawseti(L,-2,47);
  lua_pushliteral(L,"re");
  lua_rawseti(L,-2,48);
  lua_pushliteral(L,"ne");
  lua_rawseti(L,-2,49);
  lua_pushliteral(L,"en");
  lua_rawseti(L,-2,50);
  lua_pushliteral(L,"er");
  lua_rawseti(L,-2,51);
  lua_pushliteral(L,"ich");
  lua_rawseti(L,-2,52);
  lua_pushliteral(L,"the");
  lua_rawseti(L,-2,53);
  lua_pushliteral(L,"and");
  lua_rawseti(L,-2,54);
  lua_pushliteral(L,"tha");
  lua_rawseti(L,-2,55);
  lua_pushliteral(L,"ent");
  lua_rawseti(L,-2,56);
  lua_pushliteral(L,"ing");
  lua_rawseti(L,-2,57);
  lua_pushliteral(L,"ion");
  lua_rawseti(L,-2,58);
  lua_pushliteral(L,"tio");
  lua_rawseti(L,-2,59);
  lua_pushliteral(L,"for");
  lua_rawseti(L,-2,60);
  lua_pushliteral(L,"nde");
  lua_rawseti(L,-2,61);
  lua_pushliteral(L,"has");
  lua_rawseti(L,-2,62);
  lua_pushliteral(L,"nce");
  lua_rawseti(L,-2,63);
  lua_pushliteral(L,"edt");
  lua_rawseti(L,-2,64);
  lua_pushliteral(L,"tis");
  lua_rawseti(L,-2,65);
  lua_pushliteral(L,"oft");
  lua_rawseti(L,-2,66);
  lua_pushliteral(L,"sth");
  lua_rawseti(L,-2,67);
  lua_pushliteral(L,"mem");
  lua_rawseti(L,-2,68);
  lua_pushliteral(L,"ich");
  lua_rawseti(L,-2,69);
  lua_pushliteral(L,"ein");
  lua_rawseti(L,-2,70);
  lua_pushliteral(L,"und");
  lua_rawseti(L,-2,71);
  lua_pushliteral(L,"der");
  lua_rawseti(L,-2,72);
  lua_pushliteral(L,"nde");
  lua_rawseti(L,-2,73);
  lua_pushliteral(L,"sch");
  lua_rawseti(L,-2,74);
  lua_pushliteral(L,"die");
  lua_rawseti(L,-2,75);
  lua_pushliteral(L,"den");
  lua_rawseti(L,-2,76);
  lua_pushliteral(L,"end");
  lua_rawseti(L,-2,77);
  lua_pushliteral(L,"cht");
  lua_rawseti(L,-2,78);
  lua_pushliteral(L,"the");
  lua_rawseti(L,-2,79);
  lua_pushliteral(L,"and");
  lua_rawseti(L,-2,80);
  lua_pushliteral(L,"tha");
  lua_rawseti(L,-2,81);
  lua_pushliteral(L,"ent");
  lua_rawseti(L,-2,82);
  lua_pushliteral(L,"ing");
  lua_rawseti(L,-2,83);
  lua_pushliteral(L,"ion");
  lua_rawseti(L,-2,84);
  lua_pushliteral(L,"for");
  lua_rawseti(L,-2,85);
  lua_pushliteral(L,"de");
  lua_rawseti(L,-2,86);
  lua_pushliteral(L,"has");
  lua_rawseti(L,-2,87);
  lua_pushliteral(L,"ce");
  lua_rawseti(L,-2,88);
  lua_pushliteral(L,"ed");
  lua_rawseti(L,-2,89);
  lua_pushliteral(L,"is");
  lua_rawseti(L,-2,90);
  lua_pushliteral(L,"ft");
  lua_rawseti(L,-2,91);
  lua_pushliteral(L,"sth");
  lua_rawseti(L,-2,92);
  lua_pushliteral(L,"mem");
  lua_rawseti(L,-2,93);
  lua_pushliteral(L,"ch");
  lua_rawseti(L,-2,94);
  lua_pushliteral(L,"ei");
  lua_rawseti(L,-2,95);
  lua_pushliteral(L,"un");
  lua_rawseti(L,-2,96);
  lua_pushliteral(L,"der");
  lua_rawseti(L,-2,97);
  lua_pushliteral(L,"ie");
  lua_rawseti(L,-2,98);
  lua_pushliteral(L,"den");
  lua_rawseti(L,-2,99);
  lua_pushliteral(L,"end");
  lua_rawseti(L,-2,100);
  lua_pushliteral(L,"do");
  lua_rawseti(L,-2,101);
  lua_pushliteral(L,"ren");
  lua_rawseti(L,-2,102);
  lua_pushliteral(L,"nav");
  lua_rawseti(L,-2,103);
  lua_pushliteral(L,"ben");
  lua_rawseti(L,-2,104);
  lua_pushliteral(L,"ada");
  lua_rawseti(L,-2,105);
  lua_pushliteral(L,"min");
  lua_rawseti(L,-2,106);
  lua_pushliteral(L,"org");
  lua_rawseti(L,-2,107);
  lua_pushliteral(L,"san");
  lua_rawseti(L,-2,108);
  lua_pushliteral(L,"pa");
  lua_rawseti(L,-2,109);
  lua_pushliteral(L,"re");
  lua_rawseti(L,-2,110);
  lua_pushliteral(L,"ne");
  lua_rawseti(L,-2,111);
  lua_pushliteral(L,"en");
  lua_rawseti(L,-2,112);
  lua_pushliteral(L,"er");
  lua_rawseti(L,-2,113);
  lua_pushliteral(L,"ich");
  lua_rawseti(L,-2,114);
  lua_pushliteral(L,"ta");
  lua_rawseti(L,-2,115);
  lua_pushliteral(L,"bek");
  lua_rawseti(L,-2,116);
  lua_pushliteral(L,"nik");
  lua_rawseti(L,-2,117);
  lua_pushliteral(L,"le");
  lua_rawseti(L,-2,118);
  lua_pushliteral(L,"lan");
  lua_rawseti(L,-2,119);
  lua_pushliteral(L,"nem");
  lua_rawseti(L,-2,120);
  lua_pushliteral(L,"bal");
  lua_rawseti(L,-2,121);
  lua_pushliteral(L,"cir");
  lua_rawseti(L,-2,122);
  lua_pushliteral(L,"da");
  lua_rawseti(L,-2,123);
  lua_pushliteral(L,"en");
  lua_rawseti(L,-2,124);
  lua_pushliteral(L,"fan");
  lua_rawseti(L,-2,125);
  lua_pushliteral(L,"fir");
  lua_rawseti(L,-2,126);
  lua_pushliteral(L,"fern");
  lua_rawseti(L,-2,127);
  lua_pushliteral(L,"fa");
  lua_rawseti(L,-2,128);
  lua_pushliteral(L,"oak");
  lua_rawseti(L,-2,129);
  lua_pushliteral(L,"nut");
  lua_rawseti(L,-2,130);
  lua_pushliteral(L,"gen");
  lua_rawseti(L,-2,131);
  lua_pushliteral(L,"ga");
  lua_rawseti(L,-2,132);
  lua_pushliteral(L,"hu");
  lua_rawseti(L,-2,133);
  lua_pushliteral(L,"hi");
  lua_rawseti(L,-2,134);
  lua_pushliteral(L,"hal");
  lua_rawseti(L,-2,135);
  lua_pushliteral(L,"in");
  lua_rawseti(L,-2,136);
  lua_pushliteral(L,"ig");
  lua_rawseti(L,-2,137);
  lua_pushliteral(L,"ir");
  lua_rawseti(L,-2,138);
  lua_pushliteral(L,"im");
  lua_rawseti(L,-2,139);
  lua_pushliteral(L,"ja");
  lua_rawseti(L,-2,140);
  lua_pushliteral(L,"je");
  lua_rawseti(L,-2,141);
  lua_pushliteral(L,"jo");
  lua_rawseti(L,-2,142);
  lua_pushliteral(L,"kla");
  lua_rawseti(L,-2,143);
  lua_pushliteral(L,"kon");
  lua_rawseti(L,-2,144);
  lua_pushliteral(L,"ker");
  lua_rawseti(L,-2,145);
  lua_pushliteral(L,"log");
  lua_rawseti(L,-2,146);
  lua_pushliteral(L,"lag");
  lua_rawseti(L,-2,147);
  lua_pushliteral(L,"leg");
  lua_rawseti(L,-2,148);
  lua_pushliteral(L,"lil");
  lua_rawseti(L,-2,149);
  lua_pushliteral(L,"lon");
  lua_rawseti(L,-2,150);
  lua_pushliteral(L,"las");
  lua_rawseti(L,-2,151);
  lua_pushliteral(L,"leve");
  lua_rawseti(L,-2,152);
  lua_pushliteral(L,"lere");
  lua_rawseti(L,-2,153);
  lua_pushliteral(L,"mes");
  lua_rawseti(L,-2,154);
  lua_pushliteral(L,"mir");
  lua_rawseti(L,-2,155);
  lua_pushliteral(L,"mon");
  lua_rawseti(L,-2,156);
  lua_pushliteral(L,"mm");
  lua_rawseti(L,-2,157);
  lua_pushliteral(L,"mer");
  lua_rawseti(L,-2,158);
  lua_pushliteral(L,"mig");
  lua_rawseti(L,-2,159);
  lua_pushliteral(L,"na");
  lua_rawseti(L,-2,160);
  lua_pushliteral(L,"nn");
  lua_rawseti(L,-2,161);
  lua_pushliteral(L,"nerv");
  lua_rawseti(L,-2,162);
  lua_pushliteral(L,"neu");
  lua_rawseti(L,-2,163);
  lua_pushliteral(L,"oto");
  lua_rawseti(L,-2,164);
  lua_pushliteral(L,"on");
  lua_rawseti(L,-2,165);
  lua_pushliteral(L,"opt");
  lua_rawseti(L,-2,166);
  lua_pushliteral(L,"oll");
  lua_rawseti(L,-2,167);
  lua_pushliteral(L,"ome");
  lua_rawseti(L,-2,168);
  lua_pushliteral(L,"ott");
  lua_rawseti(L,-2,169);
  lua_pushliteral(L,"pen");
  lua_rawseti(L,-2,170);
  lua_pushliteral(L,"par");
  lua_rawseti(L,-2,171);
  lua_pushliteral(L,"pi");
  lua_rawseti(L,-2,172);
  lua_pushliteral(L,"pa");
  lua_rawseti(L,-2,173);
  lua_pushliteral(L,"po");
  lua_rawseti(L,-2,174);
  lua_pushliteral(L,"pel");
  lua_rawseti(L,-2,175);
  lua_pushliteral(L,"pig");
  lua_rawseti(L,-2,176);
  lua_pushliteral(L,"qu");
  lua_rawseti(L,-2,177);
  lua_pushliteral(L,"ren");
  lua_rawseti(L,-2,178);
  lua_pushliteral(L,"rig");
  lua_rawseti(L,-2,179);
  lua_pushliteral(L,"raf");
  lua_rawseti(L,-2,180);
  lua_pushliteral(L,"res");
  lua_rawseti(L,-2,181);
  lua_pushliteral(L,"ring");
  lua_rawseti(L,-2,182);
  lua_pushliteral(L,"rib");
  lua_rawseti(L,-2,183);
  lua_pushliteral(L,"rast");
  lua_rawseti(L,-2,184);
  lua_pushliteral(L,"rost");
  lua_rawseti(L,-2,185);
  lua_pushliteral(L,"ru");
  lua_rawseti(L,-2,186);
  lua_pushliteral(L,"rum");
  lua_rawseti(L,-2,187);
  lua_pushliteral(L,"rem");
  lua_rawseti(L,-2,188);
  lua_pushliteral(L,"sem");
  lua_rawseti(L,-2,189);
  lua_pushliteral(L,"sim");
  lua_rawseti(L,-2,190);
  lua_pushliteral(L,"su");
  lua_rawseti(L,-2,191);
  lua_pushliteral(L,"spring");
  lua_rawseti(L,-2,192);
  lua_pushliteral(L,"cotton");
  lua_rawseti(L,-2,193);
  lua_pushliteral(L,"cot");
  lua_rawseti(L,-2,194);
  lua_pushliteral(L,"wood");
  lua_rawseti(L,-2,195);
  lua_pushliteral(L,"palm");
  lua_rawseti(L,-2,196);
  lua_pushliteral(L,"do");
  lua_rawseti(L,-2,197);
  lua_pushliteral(L,"na");
  lua_rawseti(L,-2,198);
  lua_pushliteral(L,"ik");
  lua_rawseti(L,-2,199);
  lua_pushliteral(L,"ke");
  lua_rawseti(L,-2,200);
  lua_pushliteral(L,"gen");
  lua_rawseti(L,-2,201);
  lua_pushliteral(L,"bra");
  lua_rawseti(L,-2,202);
  lua_pushliteral(L,"bn");
  lua_rawseti(L,-2,203);
  lua_pushliteral(L,"lla");
  lua_rawseti(L,-2,204);
  lua_pushliteral(L,"lle");
  lua_rawseti(L,-2,205);
  lua_pushliteral(L,"st");
  lua_rawseti(L,-2,206);
  lua_pushliteral(L,"aa");
  lua_rawseti(L,-2,207);
  lua_pushliteral(L,"kir");
  lua_rawseti(L,-2,208);
  lua_pushliteral(L,"nn");
  lua_rawseti(L,-2,209);
  lua_pushliteral(L,"en");
  lua_rawseti(L,-2,210);
  lua_pushliteral(L,"fo");
  lua_rawseti(L,-2,211);
  lua_pushliteral(L,"fn");
  lua_rawseti(L,-2,212);
  lua_pushliteral(L,"gi");
  lua_rawseti(L,-2,213);
  lua_pushliteral(L,"ja");
  lua_rawseti(L,-2,214);
  lua_pushliteral(L,"jn");
  lua_rawseti(L,-2,215);
  lua_pushliteral(L,"ke");
  lua_rawseti(L,-2,216);
  lua_pushliteral(L,"kr");
  lua_rawseti(L,-2,217);
  lua_pushliteral(L,"kon");
  lua_rawseti(L,-2,218);
  lua_pushliteral(L,"lis");
  lua_rawseti(L,-2,219);
  lua_pushliteral(L,"on");
  lua_rawseti(L,-2,220);
  lua_pushliteral(L,"ok");
  lua_rawseti(L,-2,221);
  lua_pushliteral(L,"or");
  lua_rawseti(L,-2,222);
  lua_pushliteral(L,"op");
  lua_rawseti(L,-2,223);
  lua_pushliteral(L,"pp");
  lua_rawseti(L,-2,224);
  lua_pushliteral(L,"p");
  lua_rawseti(L,-2,225);
  lua_pushliteral(L,"qu");
  lua_rawseti(L,-2,226);
  lua_pushliteral(L,"re");
  lua_rawseti(L,-2,227);
  lua_pushliteral(L,"ra");
  lua_rawseti(L,-2,228);
  lua_pushliteral(L,"rn");
  lua_rawseti(L,-2,229);
  lua_pushliteral(L,"ri");
  lua_rawseti(L,-2,230);
  lua_pushliteral(L,"so");
  lua_rawseti(L,-2,231);
  lua_pushliteral(L,"sn");
  lua_rawseti(L,-2,232);
  lua_pushliteral(L,"se");
  lua_rawseti(L,-2,233);
  lua_pushliteral(L,"ti");
  lua_rawseti(L,-2,234);
  lua_pushliteral(L,"tu");
  lua_rawseti(L,-2,235);
  lua_pushliteral(L,"a");
  lua_rawseti(L,-2,236);
  lua_pushliteral(L,"e");
  lua_rawseti(L,-2,237);
  lua_pushliteral(L,"i");
  lua_rawseti(L,-2,238);
  lua_pushliteral(L,"o");
  lua_rawseti(L,-2,239);
  lua_pushliteral(L,"u");
  lua_rawseti(L,-2,240);
  lua_pushliteral(L,"re");
  lua_rawseti(L,-2,241);
  lua_pushliteral(L,"ro");
  lua_rawseti(L,-2,242);
  lua_pushliteral(L,"pe");
  lua_rawseti(L,-2,243);
  lua_pushliteral(L,"pn");
  lua_rawseti(L,-2,244);
  lua_pushliteral(L,"ci");
  lua_rawseti(L,-2,245);
  lua_pushliteral(L,"co");
  lua_rawseti(L,-2,246);
  lua_pushliteral(L,"cl");
  lua_rawseti(L,-2,247);
  lua_pushliteral(L,"no");
  lua_rawseti(L,-2,248);
  lua_pushliteral(L,"en");
  lua_rawseti(L,-2,249);
  lua_pushliteral(L,"wi");
  lua_rawseti(L,-2,250);
  lua_pushliteral(L,"we");
  lua_rawseti(L,-2,251);
  lua_pushliteral(L,"er");
  lua_rawseti(L,-2,252);
  lua_pushliteral(L,"en");
  lua_rawseti(L,-2,253);
  lua_pushliteral(L,"ba");
  lua_rawseti(L,-2,254);
  lua_pushliteral(L,"ki");
  lua_rawseti(L,-2,255);
  lua_pushliteral(L,"nn");
  lua_rawseti(L,-2,256);
  lua_pushliteral(L,"va");
  lua_rawseti(L,-2,257);
  lua_pushliteral(L,"wu");
  lua_rawseti(L,-2,258);
  lua_pushliteral(L,"x");
  lua_rawseti(L,-2,259);
  lua_pushliteral(L,"tel");
  lua_rawseti(L,-2,260);
  lua_pushliteral(L,"or");
  lua_rawseti(L,-2,261);
  lua_pushliteral(L,"so");
  lua_rawseti(L,-2,262);
  lua_pushliteral(L,"me");
  lua_rawseti(L,-2,263);
  lua_pushliteral(L,"mi");
  lua_rawseti(L,-2,264);
  lua_pushliteral(L,"em");
  lua_rawseti(L,-2,265);
  lua_pushliteral(L,"en");
  lua_rawseti(L,-2,266);
  lua_pushliteral(L,"eg");
  lua_rawseti(L,-2,267);
  lua_pushliteral(L,"ge");
  lua_rawseti(L,-2,268);
  lua_pushliteral(L,"kn");
  lua_rawseti(L,-2,269);
  lua_getfield(L,LUA_ENVIRONINDEX,"namegen");
  lua_insert(L,-2);
  lua_pushliteral(L,"silben");
  lua_insert(L,-2);
  lua_settable(L,-3);
  lua_pop(L,1);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* namegen.generate_village_name = function( pr )
   * 	local anz_silben = pr:next(2,5);
   * 	local name = '';
   * 	local prefix  = '';
   * 	local postfix = '';
   * 	if( pr:next(1,8)==1) then
   * 		prefix = namegen.prefixes[ #namegen.prefixes ];
   * 		anz_silben = anz_silben -1;
   * 	end
   * 	if( pr:next(1,4)==1) then
   * 		postfix = name..namegen.suffixes[ #namegen.suffixes ];
   * 		anz_silben = anz_silben -2;
   * 	end
   * 	if( anz_silben < 2 ) then
   * 		anz_silben = 2;
   * 	end
   * 	for i = 1, anz_silben do
   * 		name = name..namegen.silben[ pr:next( 1, #namegen.silben )];
   * 	end
   * 	name = prefix..name..postfix;
   * 	name = string.upper( string.sub( name, 1, 1 ) )..string.sub( name, 2 );
   * 	return name;
   * end */
  lua_pushcfunction(L,lcf1_namegen_generate_village_name);
  lua_getfield(L,LUA_ENVIRONINDEX,"namegen");
  lua_insert(L,-2);
  lua_pushliteral(L,"generate_village_name");
  lua_insert(L,-2);
  lua_settable(L,-3);
  lua_pop(L,1);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* namegen.generate_village_name_with_prefix = function( pr, village )
   * 
   * 	local name = namegen.generate_village_name( pr );
   * 
   * 	-- if a village consists of a single house, it gets a prefix depending on the house type
   * 	if( village.is_single_house and village.to_add_data and village.to_add_data.bpos ) then
   * 		-- the building got removed from mg_villages.BUILDINGS in the meantime
   * 		if( not( mg_villages.BUILDINGS[ village.to_add_data.bpos[1].btype] )) then
   * 			return 'Abandomed building';
   * 		end
   * 		local btyp = mg_villages.BUILDINGS[ village.to_add_data.bpos[1].btype].typ;
   * 		local bdata = mg_villages.village_type_data[ btyp ];
   * 		if( bdata and (bdata.name_prefix or bdata.name_postfix )) then
   * 			name = (bdata.name_prefix or '')..name..(bdata.name_postfix or '');
   * 		else			
   * 			name = 'House '..name;
   * 		end
   * 	end
   * 	return name;
   * end */
  lua_pushcfunction(L,lcf1_namegen_generate_village_name_with_prefix);
  lua_getfield(L,LUA_ENVIRONINDEX,"namegen");
  lua_insert(L,-2);
  lua_pushliteral(L,"generate_village_name_with_prefix");
  lua_insert(L,-2);
  lua_settable(L,-3);
  lua_pop(L,1);
  assert(lua_gettop(L) - lc_nextra == 0);
  return 0;
}


/* from lua.c */
static int traceback (lua_State *L) {
  if (!lua_isstring(L, 1))  /* 'message' not a string? */
    return 1;  /* keep it intact */
  lua_getfield(L, LUA_GLOBALSINDEX, "debug");
  if (!lua_istable(L, -1)) {
    lua_pop(L, 1);
    return 1;
  }
  lua_getfield(L, -1, "traceback");
  if (!lua_isfunction(L, -1)) {
    lua_pop(L, 2);
    return 1;
  }
  lua_pushvalue(L, 1);  /* pass error message */
  lua_pushinteger(L, 2);  /* skip this function and traceback */
  lua_call(L, 2, 1);  /* call debug.traceback */
  return 1;
}


static void lc_l_message (const char *pname, const char *msg) {
  if (pname) fprintf(stderr, "%s: ", pname);
  fprintf(stderr, "%s\n", msg);
  fflush(stderr);
}

static int lc_report (lua_State *L, int status) {
  if (status && !lua_isnil(L, -1)) {
    const char *msg = lua_tostring(L, -1);
    if (msg == NULL) msg = "(error object is not a string)";
    /*FIX-IMROVE:progname*/
    lc_l_message("lua", msg);
    lua_pop(L, 1);
  }
  return status;
}

static int lc_docall (lua_State *L, int narg, int clear) {
  int status;
  int base = lua_gettop(L) - narg;  /* function index */
  lua_pushcfunction(L, traceback);  /* push traceback function */
  lua_insert(L, base);  /* put it under chunk and args */
  /*FIX? signal(SIGINT, laction); */
  status = lua_pcall(L, narg, (clear ? 0 : LUA_MULTRET), base);
  /*FIX? signal(SIGINT, SIG_DFL); */
  lua_remove(L, base);  /* remove traceback function */
  /* force a complete garbage collection in case of errors */
  if (status != 0) lua_gc(L, LUA_GCCOLLECT, 0);
  return status;
}

static int lc_dofile (lua_State *L, const char *name) {
  int status = luaL_loadfile(L, name) || lc_docall(L, 0, 1);
  return lc_report(L, status);
}

static int lc_dostring (lua_State *L, const char *s, const char *name) {
  int status = luaL_loadbuffer(L, s, strlen(s), name) || lc_docall(L, 0, 1);
  return lc_report(L, status);
}

static int lc_handle_luainit (lua_State *L) {
  const char *init = getenv(LUA_INIT);
  if (init == NULL) return 0;  /* status OK */
  else if (init[0] == '@')
    return lc_dofile(L, init+1);
  else
    return lc_dostring(L, init, "=" LUA_INIT);
}


typedef struct {
  int c;
  const char ** v;
} lc_args_t;


/* create global arg table */
static void lc_createarg(lua_State * L, const lc_args_t * const args) {
  int i;
  lua_newtable(L);
  for (i=0; i < args->c; i++) {
    lua_pushstring(L, args->v[i]);
    lua_rawseti(L, -2, i);
  }
  lua_setglobal(L, "arg");
}


int lc_pmain_mod_mg_villages_name_gen(lua_State * L) {
  luaL_openlibs(L);

  lua_pushcfunction(L, traceback);

  const int status1 = lc_handle_luainit(L);
  if (status1 != 0) return 0;

  /* note: IMPROVE: closure not always needed here */
  lua_newtable(L); /* closure table */
  lua_pushcclosure(L, lcf_main, 1);

  int status2 = lua_pcall(L, 0, 0, -2);
  if (status2 != 0) {
    const char * msg = lua_tostring(L,-1);
    if (msg == NULL) msg = "(error object is not a string)";
    fputs(msg, stderr);
  }
  return 0;
}



