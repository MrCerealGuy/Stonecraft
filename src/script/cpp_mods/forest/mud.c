/* WARNING: This file was automatically generated by lua2c. */

#ifdef __cplusplus
extern "C" {
#endif
#include <lua.h>
#include <lauxlib.h>
#include <lualib.h>
#ifdef __cplusplus
}
#endif
#include <stdio.h>
#include <stdlib.h>


#include <string.h>


#include <assert.h>

/* name: (main)
 * function(...) */
static int lcf_main (lua_State * L) {
  enum { lc_nformalargs = 0 };
  #ifndef NDEBUG
  const int lc_nactualargs = lua_gettop(L);
  #endif
  #ifndef NDEBUG
  const int lc_nextra = (lc_nactualargs - lc_nformalargs);
  #endif
  
  /* minetest.register_node("forest:mud_flowing", {
   * 	description = "Mud flowing",
   * 	inventory_image = minetest.inventorycube("mud.png"),
   * 	drawtype = "flowingliquid",
   * 	tiles = {"mud.png"},
   * 	special_tiles = {
   * 		{
   * 			image="mud_animated.png",
   * 			backface_culling=false,
   * 			animation={type="vertical_frames", aspect_w=16, aspect_h=16, length=4}
   * 		},
   * 		{
   * 			image="mud_animated.png",
   * 			backface_culling=true,
   * 			animation={type="vertical_frames", aspect_w=16, aspect_h=16, length=4}
   * 		},
   * 	},
   * 	paramtype = "light",
   * 	paramtype2 = "flowingliquid",
   * 	walkable = false,
   * 	pointable = false,
   * 	diggable = false,
   * 	buildable_to = true,
   * 	drop = "",
   * 	drowning = 1,
   * 	liquidtype = "flowing",
   * 	liquid_alternative_flowing = "forest:mud_flowing",
   * 	liquid_alternative_source = "forest:mud_source",
   * 	liquid_viscosity = 6,
   * 	freezemelt = "default:snow",
   * 	post_effect_color = {a=224, r=112, g=64, b=32},
   * 	groups = {liquid=3, puts_out_fire=1, not_in_creative_inventory=1, freezes=1, melt_around=1, water=1},
   * }) */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"register_node");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"forest:mud_flowing");
  lua_createtable(L,0,20);
  lua_pushliteral(L,"description");
  lua_pushliteral(L,"Mud flowing");
  lua_rawset(L,-3);
  lua_pushliteral(L,"inventory_image");
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"inventorycube");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"mud.png");
  lua_call(L,1,1);
  lua_rawset(L,-3);
  lua_pushliteral(L,"drawtype");
  lua_pushliteral(L,"flowingliquid");
  lua_rawset(L,-3);
  lua_pushliteral(L,"tiles");
  lua_createtable(L,1,0);
  lua_pushliteral(L,"mud.png");
  lua_rawseti(L,-2,1);
  lua_rawset(L,-3);
  lua_pushliteral(L,"special_tiles");
  lua_createtable(L,2,0);
  lua_createtable(L,0,3);
  lua_pushliteral(L,"image");
  lua_pushliteral(L,"mud_animated.png");
  lua_rawset(L,-3);
  lua_pushliteral(L,"backface_culling");
  lua_pushboolean(L,0);
  lua_rawset(L,-3);
  lua_pushliteral(L,"animation");
  lua_createtable(L,0,4);
  lua_pushliteral(L,"type");
  lua_pushliteral(L,"vertical_frames");
  lua_rawset(L,-3);
  lua_pushliteral(L,"aspect_w");
  lua_pushnumber(L,16);
  lua_rawset(L,-3);
  lua_pushliteral(L,"aspect_h");
  lua_pushnumber(L,16);
  lua_rawset(L,-3);
  lua_pushliteral(L,"length");
  lua_pushnumber(L,4);
  lua_rawset(L,-3);
  lua_rawset(L,-3);
  lua_rawseti(L,-2,1);
  lua_createtable(L,0,3);
  lua_pushliteral(L,"image");
  lua_pushliteral(L,"mud_animated.png");
  lua_rawset(L,-3);
  lua_pushliteral(L,"backface_culling");
  lua_pushboolean(L,1);
  lua_rawset(L,-3);
  lua_pushliteral(L,"animation");
  lua_createtable(L,0,4);
  lua_pushliteral(L,"type");
  lua_pushliteral(L,"vertical_frames");
  lua_rawset(L,-3);
  lua_pushliteral(L,"aspect_w");
  lua_pushnumber(L,16);
  lua_rawset(L,-3);
  lua_pushliteral(L,"aspect_h");
  lua_pushnumber(L,16);
  lua_rawset(L,-3);
  lua_pushliteral(L,"length");
  lua_pushnumber(L,4);
  lua_rawset(L,-3);
  lua_rawset(L,-3);
  lua_rawseti(L,-2,2);
  lua_rawset(L,-3);
  lua_pushliteral(L,"paramtype");
  lua_pushliteral(L,"light");
  lua_rawset(L,-3);
  lua_pushliteral(L,"paramtype2");
  lua_pushliteral(L,"flowingliquid");
  lua_rawset(L,-3);
  lua_pushliteral(L,"walkable");
  lua_pushboolean(L,0);
  lua_rawset(L,-3);
  lua_pushliteral(L,"pointable");
  lua_pushboolean(L,0);
  lua_rawset(L,-3);
  lua_pushliteral(L,"diggable");
  lua_pushboolean(L,0);
  lua_rawset(L,-3);
  lua_pushliteral(L,"buildable_to");
  lua_pushboolean(L,1);
  lua_rawset(L,-3);
  lua_pushliteral(L,"drop");
  lua_pushliteral(L,"");
  lua_rawset(L,-3);
  lua_pushliteral(L,"drowning");
  lua_pushnumber(L,1);
  lua_rawset(L,-3);
  lua_pushliteral(L,"liquidtype");
  lua_pushliteral(L,"flowing");
  lua_rawset(L,-3);
  lua_pushliteral(L,"liquid_alternative_flowing");
  lua_pushliteral(L,"forest:mud_flowing");
  lua_rawset(L,-3);
  lua_pushliteral(L,"liquid_alternative_source");
  lua_pushliteral(L,"forest:mud_source");
  lua_rawset(L,-3);
  lua_pushliteral(L,"liquid_viscosity");
  lua_pushnumber(L,6);
  lua_rawset(L,-3);
  lua_pushliteral(L,"freezemelt");
  lua_pushliteral(L,"default:snow");
  lua_rawset(L,-3);
  lua_pushliteral(L,"post_effect_color");
  lua_createtable(L,0,4);
  lua_pushliteral(L,"a");
  lua_pushnumber(L,224);
  lua_rawset(L,-3);
  lua_pushliteral(L,"r");
  lua_pushnumber(L,112);
  lua_rawset(L,-3);
  lua_pushliteral(L,"g");
  lua_pushnumber(L,64);
  lua_rawset(L,-3);
  lua_pushliteral(L,"b");
  lua_pushnumber(L,32);
  lua_rawset(L,-3);
  lua_rawset(L,-3);
  lua_pushliteral(L,"groups");
  lua_createtable(L,0,6);
  lua_pushliteral(L,"liquid");
  lua_pushnumber(L,3);
  lua_rawset(L,-3);
  lua_pushliteral(L,"puts_out_fire");
  lua_pushnumber(L,1);
  lua_rawset(L,-3);
  lua_pushliteral(L,"not_in_creative_inventory");
  lua_pushnumber(L,1);
  lua_rawset(L,-3);
  lua_pushliteral(L,"freezes");
  lua_pushnumber(L,1);
  lua_rawset(L,-3);
  lua_pushliteral(L,"melt_around");
  lua_pushnumber(L,1);
  lua_rawset(L,-3);
  lua_pushliteral(L,"water");
  lua_pushnumber(L,1);
  lua_rawset(L,-3);
  lua_rawset(L,-3);
  lua_call(L,2,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* minetest.register_node("forest:mud_source", {
   * 	description = "Mud source",
   * 	inventory_image = minetest.inventorycube("mud.png"),
   * 	drawtype = "liquid",
   * 	tiles = {
   * 		{name="mud_animated.png", animation={type="vertical_frames", aspect_w=16, aspect_h=16, length=9}}
   * 	},
   * 	special_tiles = {
   * 		{
   * 			name="mud_animated.png",
   * 			animation={type="vertical_frames", aspect_w=16, aspect_h=16, length=9},
   * 			backface_culling = false,
   * 		}
   * 	},
   * 	paramtype = "light",
   * 	walkable = false,
   * 	pointable = false,
   * 	diggable = false,
   * 	buildable_to = true,
   * 	drop = "",
   * 	drowning = 1,
   * 	liquidtype = "source",
   * 	liquid_alternative_flowing = "forest:mud_flowing",
   * 	liquid_alternative_source = "forest:mud_source",
   * 	liquid_viscosity = 6,
   * 	freezemelt = "default:ice",
   * 	post_effect_color = {a=64, r=100, g=100, b=200},
   * 	groups = {liquid=3, puts_out_fire=1, freezes=1, water=1},
   * }) */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"register_node");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"forest:mud_source");
  lua_createtable(L,0,19);
  lua_pushliteral(L,"description");
  lua_pushliteral(L,"Mud source");
  lua_rawset(L,-3);
  lua_pushliteral(L,"inventory_image");
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"inventorycube");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"mud.png");
  lua_call(L,1,1);
  lua_rawset(L,-3);
  lua_pushliteral(L,"drawtype");
  lua_pushliteral(L,"liquid");
  lua_rawset(L,-3);
  lua_pushliteral(L,"tiles");
  lua_createtable(L,1,0);
  lua_createtable(L,0,2);
  lua_pushliteral(L,"name");
  lua_pushliteral(L,"mud_animated.png");
  lua_rawset(L,-3);
  lua_pushliteral(L,"animation");
  lua_createtable(L,0,4);
  lua_pushliteral(L,"type");
  lua_pushliteral(L,"vertical_frames");
  lua_rawset(L,-3);
  lua_pushliteral(L,"aspect_w");
  lua_pushnumber(L,16);
  lua_rawset(L,-3);
  lua_pushliteral(L,"aspect_h");
  lua_pushnumber(L,16);
  lua_rawset(L,-3);
  lua_pushliteral(L,"length");
  lua_pushnumber(L,9);
  lua_rawset(L,-3);
  lua_rawset(L,-3);
  lua_rawseti(L,-2,1);
  lua_rawset(L,-3);
  lua_pushliteral(L,"special_tiles");
  lua_createtable(L,1,0);
  lua_createtable(L,0,3);
  lua_pushliteral(L,"name");
  lua_pushliteral(L,"mud_animated.png");
  lua_rawset(L,-3);
  lua_pushliteral(L,"animation");
  lua_createtable(L,0,4);
  lua_pushliteral(L,"type");
  lua_pushliteral(L,"vertical_frames");
  lua_rawset(L,-3);
  lua_pushliteral(L,"aspect_w");
  lua_pushnumber(L,16);
  lua_rawset(L,-3);
  lua_pushliteral(L,"aspect_h");
  lua_pushnumber(L,16);
  lua_rawset(L,-3);
  lua_pushliteral(L,"length");
  lua_pushnumber(L,9);
  lua_rawset(L,-3);
  lua_rawset(L,-3);
  lua_pushliteral(L,"backface_culling");
  lua_pushboolean(L,0);
  lua_rawset(L,-3);
  lua_rawseti(L,-2,1);
  lua_rawset(L,-3);
  lua_pushliteral(L,"paramtype");
  lua_pushliteral(L,"light");
  lua_rawset(L,-3);
  lua_pushliteral(L,"walkable");
  lua_pushboolean(L,0);
  lua_rawset(L,-3);
  lua_pushliteral(L,"pointable");
  lua_pushboolean(L,0);
  lua_rawset(L,-3);
  lua_pushliteral(L,"diggable");
  lua_pushboolean(L,0);
  lua_rawset(L,-3);
  lua_pushliteral(L,"buildable_to");
  lua_pushboolean(L,1);
  lua_rawset(L,-3);
  lua_pushliteral(L,"drop");
  lua_pushliteral(L,"");
  lua_rawset(L,-3);
  lua_pushliteral(L,"drowning");
  lua_pushnumber(L,1);
  lua_rawset(L,-3);
  lua_pushliteral(L,"liquidtype");
  lua_pushliteral(L,"source");
  lua_rawset(L,-3);
  lua_pushliteral(L,"liquid_alternative_flowing");
  lua_pushliteral(L,"forest:mud_flowing");
  lua_rawset(L,-3);
  lua_pushliteral(L,"liquid_alternative_source");
  lua_pushliteral(L,"forest:mud_source");
  lua_rawset(L,-3);
  lua_pushliteral(L,"liquid_viscosity");
  lua_pushnumber(L,6);
  lua_rawset(L,-3);
  lua_pushliteral(L,"freezemelt");
  lua_pushliteral(L,"default:ice");
  lua_rawset(L,-3);
  lua_pushliteral(L,"post_effect_color");
  lua_createtable(L,0,4);
  lua_pushliteral(L,"a");
  lua_pushnumber(L,64);
  lua_rawset(L,-3);
  lua_pushliteral(L,"r");
  lua_pushnumber(L,100);
  lua_rawset(L,-3);
  lua_pushliteral(L,"g");
  lua_pushnumber(L,100);
  lua_rawset(L,-3);
  lua_pushliteral(L,"b");
  lua_pushnumber(L,200);
  lua_rawset(L,-3);
  lua_rawset(L,-3);
  lua_pushliteral(L,"groups");
  lua_createtable(L,0,4);
  lua_pushliteral(L,"liquid");
  lua_pushnumber(L,3);
  lua_rawset(L,-3);
  lua_pushliteral(L,"puts_out_fire");
  lua_pushnumber(L,1);
  lua_rawset(L,-3);
  lua_pushliteral(L,"freezes");
  lua_pushnumber(L,1);
  lua_rawset(L,-3);
  lua_pushliteral(L,"water");
  lua_pushnumber(L,1);
  lua_rawset(L,-3);
  lua_rawset(L,-3);
  lua_call(L,2,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* minetest.register_node("forest:mud_ice", {
   * 	description = "Mud ice",
   * 	drawtype = "glasslike",
   * 	tiles = {"mud.png^new_ice.png"},
   * 	is_ground_content = true,
   * 	paramtype = "light",
   * 	freezemelt = "default:mud_source",
   * 	groups = {cracky=3, melts=1},
   * 	sounds = default.node_sound_glass_defaults(),
   * }) */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"register_node");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"forest:mud_ice");
  lua_createtable(L,0,8);
  lua_pushliteral(L,"description");
  lua_pushliteral(L,"Mud ice");
  lua_rawset(L,-3);
  lua_pushliteral(L,"drawtype");
  lua_pushliteral(L,"glasslike");
  lua_rawset(L,-3);
  lua_pushliteral(L,"tiles");
  lua_createtable(L,1,0);
  lua_pushliteral(L,"mud.png^new_ice.png");
  lua_rawseti(L,-2,1);
  lua_rawset(L,-3);
  lua_pushliteral(L,"is_ground_content");
  lua_pushboolean(L,1);
  lua_rawset(L,-3);
  lua_pushliteral(L,"paramtype");
  lua_pushliteral(L,"light");
  lua_rawset(L,-3);
  lua_pushliteral(L,"freezemelt");
  lua_pushliteral(L,"default:mud_source");
  lua_rawset(L,-3);
  lua_pushliteral(L,"groups");
  lua_createtable(L,0,2);
  lua_pushliteral(L,"cracky");
  lua_pushnumber(L,3);
  lua_rawset(L,-3);
  lua_pushliteral(L,"melts");
  lua_pushnumber(L,1);
  lua_rawset(L,-3);
  lua_rawset(L,-3);
  lua_pushliteral(L,"sounds");
  lua_getfield(L,LUA_ENVIRONINDEX,"default");
  lua_pushliteral(L,"node_sound_glass_defaults");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_call(L,0,1);
  lua_rawset(L,-3);
  lua_call(L,2,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* minetest.register_craft({
   * 	type = "shapeless",
   * 	output = "forest:bucket_mud",
   * 	recipe = {"bucket:bucket_water", "default:dirt"},
   * }) */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"register_craft");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_createtable(L,0,3);
  lua_pushliteral(L,"type");
  lua_pushliteral(L,"shapeless");
  lua_rawset(L,-3);
  lua_pushliteral(L,"output");
  lua_pushliteral(L,"forest:bucket_mud");
  lua_rawset(L,-3);
  lua_pushliteral(L,"recipe");
  lua_createtable(L,2,0);
  lua_pushliteral(L,"bucket:bucket_water");
  lua_rawseti(L,-2,1);
  lua_pushliteral(L,"default:dirt");
  lua_rawseti(L,-2,2);
  lua_rawset(L,-3);
  lua_call(L,1,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* bucket.register_liquid(
   * 	"forest:mud_source",
   * 	"forest:mud_flowing",
   * 	"forest:bucket_mud",
   * 	"bucket_mud.png",
   * 	"Mud bucket"
   * ) */
  lua_getfield(L,LUA_ENVIRONINDEX,"bucket");
  lua_pushliteral(L,"register_liquid");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"forest:mud_source");
  lua_pushliteral(L,"forest:mud_flowing");
  lua_pushliteral(L,"forest:bucket_mud");
  lua_pushliteral(L,"bucket_mud.png");
  lua_pushliteral(L,"Mud bucket");
  lua_call(L,5,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  return 0;
}


/* from lua.c */
static int traceback (lua_State *L) {
  if (!lua_isstring(L, 1))  /* 'message' not a string? */
    return 1;  /* keep it intact */
  lua_getfield(L, LUA_GLOBALSINDEX, "debug");
  if (!lua_istable(L, -1)) {
    lua_pop(L, 1);
    return 1;
  }
  lua_getfield(L, -1, "traceback");
  if (!lua_isfunction(L, -1)) {
    lua_pop(L, 2);
    return 1;
  }
  lua_pushvalue(L, 1);  /* pass error message */
  lua_pushinteger(L, 2);  /* skip this function and traceback */
  lua_call(L, 2, 1);  /* call debug.traceback */
  return 1;
}


static void lc_l_message (const char *pname, const char *msg) {
  if (pname) fprintf(stderr, "%s: ", pname);
  fprintf(stderr, "%s\n", msg);
  fflush(stderr);
}

static int lc_report (lua_State *L, int status) {
  if (status && !lua_isnil(L, -1)) {
    const char *msg = lua_tostring(L, -1);
    if (msg == NULL) msg = "(error object is not a string)";
    /*FIX-IMROVE:progname*/
    lc_l_message("lua", msg);
    lua_pop(L, 1);
  }
  return status;
}

static int lc_docall (lua_State *L, int narg, int clear) {
  int status;
  int base = lua_gettop(L) - narg;  /* function index */
  lua_pushcfunction(L, traceback);  /* push traceback function */
  lua_insert(L, base);  /* put it under chunk and args */
  /*FIX? signal(SIGINT, laction); */
  status = lua_pcall(L, narg, (clear ? 0 : LUA_MULTRET), base);
  /*FIX? signal(SIGINT, SIG_DFL); */
  lua_remove(L, base);  /* remove traceback function */
  /* force a complete garbage collection in case of errors */
  if (status != 0) lua_gc(L, LUA_GCCOLLECT, 0);
  return status;
}

static int lc_dofile (lua_State *L, const char *name) {
  int status = luaL_loadfile(L, name) || lc_docall(L, 0, 1);
  return lc_report(L, status);
}

static int lc_dostring (lua_State *L, const char *s, const char *name) {
  int status = luaL_loadbuffer(L, s, strlen(s), name) || lc_docall(L, 0, 1);
  return lc_report(L, status);
}

static int lc_handle_luainit (lua_State *L) {
  const char *init = getenv(LUA_INIT);
  if (init == NULL) return 0;  /* status OK */
  else if (init[0] == '@')
    return lc_dofile(L, init+1);
  else
    return lc_dostring(L, init, "=" LUA_INIT);
}


typedef struct {
  int c;
  const char ** v;
} lc_args_t;


/* create global arg table */
static void lc_createarg(lua_State * L, const lc_args_t * const args) {
  int i;
  lua_newtable(L);
  for (i=0; i < args->c; i++) {
    lua_pushstring(L, args->v[i]);
    lua_rawseti(L, -2, i);
  }
  lua_setglobal(L, "arg");
}


int lc_pmain_mod_forest_mud(lua_State * L) {
	  luaL_openlibs(L);

	  lua_pushcfunction(L, traceback);

	  const int status1 = lc_handle_luainit(L);
	  if (status1 != 0) return 0;

	  /* note: IMPROVE: closure not always needed here */
	  lua_newtable(L); /* closure table */
	  lua_pushcclosure(L, lcf_main, 1);

	  int status2 = lua_pcall(L, 0, 0, -2);
	  if (status2 != 0) {
	    const char * msg = lua_tostring(L,-1);
	    if (msg == NULL) msg = "(error object is not a string)";
	    fputs(msg, stderr);
	  }
	  return 0;
	}


