/* WARNING: This file was automatically generated by lua2c. */

#ifdef __cplusplus
extern "C" {
#endif
#include <lua.h>
#include <lauxlib.h>
#include <lualib.h>
#ifdef __cplusplus
}
#endif
#include <stdio.h>
#include <stdlib.h>


#include <string.h>


#include <assert.h>

/* name: (main)
 * function(...) */
static int lcf_main (lua_State * L) {
  enum { lc_nformalargs = 0 };
  const int lc_nactualargs = lua_gettop(L);
  const int lc_nextra = (lc_nactualargs - lc_nformalargs);
  
  /* -- add compatibility for ethereal nodes already in default game or name changed
   * minetest.register_alias("ethereal:acacia_trunk", "default:acacia_tree") */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"register_alias");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"ethereal:acacia_trunk");
  lua_pushliteral(L,"default:acacia_tree");
  lua_call(L,2,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* minetest.register_alias("ethereal:acacia_wood", "default:acacia_wood") */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"register_alias");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"ethereal:acacia_wood");
  lua_pushliteral(L,"default:acacia_wood");
  lua_call(L,2,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* minetest.register_alias("ethereal:fence_acacia", "default:fence_acacia_wood") */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"register_alias");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"ethereal:fence_acacia");
  lua_pushliteral(L,"default:fence_acacia_wood");
  lua_call(L,2,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* minetest.register_alias("ethereal:fence_junglewood", "default:fence_junglewood") */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"register_alias");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"ethereal:fence_junglewood");
  lua_pushliteral(L,"default:fence_junglewood");
  lua_call(L,2,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* minetest.register_alias("ethereal:fence_pine", "default:fence_pine_wood") */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"register_alias");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"ethereal:fence_pine");
  lua_pushliteral(L,"default:fence_pine_wood");
  lua_call(L,2,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* minetest.register_alias("ethereal:acacia_leaves", "default:acacia_leaves") */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"register_alias");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"ethereal:acacia_leaves");
  lua_pushliteral(L,"default:acacia_leaves");
  lua_call(L,2,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* minetest.register_alias("ethereal:pineleaves", "default:pine_needles") */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"register_alias");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"ethereal:pineleaves");
  lua_pushliteral(L,"default:pine_needles");
  lua_call(L,2,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* minetest.register_alias("ethereal:mushroom_craftingitem", "flowers:mushroom_brown") */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"register_alias");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"ethereal:mushroom_craftingitem");
  lua_pushliteral(L,"flowers:mushroom_brown");
  lua_call(L,2,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* minetest.register_alias("ethereal:mushroom_plant", "flowers:mushroom_brown") */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"register_alias");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"ethereal:mushroom_plant");
  lua_pushliteral(L,"flowers:mushroom_brown");
  lua_call(L,2,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* minetest.register_alias("ethereal:mushroom_soup_cooked", "ethereal:mushroom_soup") */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"register_alias");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"ethereal:mushroom_soup_cooked");
  lua_pushliteral(L,"ethereal:mushroom_soup");
  lua_call(L,2,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* minetest.register_alias("ethereal:mushroom_1", "flowers:mushroom_brown") */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"register_alias");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"ethereal:mushroom_1");
  lua_pushliteral(L,"flowers:mushroom_brown");
  lua_call(L,2,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* minetest.register_alias("ethereal:mushroom_2", "flowers:mushroom_brown") */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"register_alias");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"ethereal:mushroom_2");
  lua_pushliteral(L,"flowers:mushroom_brown");
  lua_call(L,2,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* minetest.register_alias("ethereal:mushroom_3", "flowers:mushroom_brown") */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"register_alias");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"ethereal:mushroom_3");
  lua_pushliteral(L,"flowers:mushroom_brown");
  lua_call(L,2,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* minetest.register_alias("ethereal:mushroom_4", "flowers:mushroom_brown") */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"register_alias");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"ethereal:mushroom_4");
  lua_pushliteral(L,"flowers:mushroom_brown");
  lua_call(L,2,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* minetest.register_alias("ethereal:strawberry_bush", "ethereal:strawberry_7") */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"register_alias");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"ethereal:strawberry_bush");
  lua_pushliteral(L,"ethereal:strawberry_7");
  lua_call(L,2,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* minetest.register_alias("ethereal:seed_strawberry", "ethereal:strawberry") */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"register_alias");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"ethereal:seed_strawberry");
  lua_pushliteral(L,"ethereal:strawberry");
  lua_call(L,2,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* for i = 1, 5 do */
  lua_pushnumber(L,1);
  lua_pushnumber(L,5);
  if (!((lua_isnumber(L,-2) && lua_isnumber(L,-1)))) {
    luaL_error(L,"'for' limit must be a number");
  }
  double lc1_var = lua_tonumber(L,-2);
  const double lc2_limit = lua_tonumber(L,-1);
  const double lc3_step = 1;
  lua_pop(L,2);
  enum { lc4 = 0 };
  while ((((lc3_step > 0) && (lc1_var <= lc2_limit)) || ((lc3_step <= 0) && (lc1_var >= lc2_limit)))) {
    
    /* internal: local i at index 1 */
    lua_pushnumber(L,lc1_var);
    
    /* minetest.register_alias("ethereal:wild_onion_"..i, "ethereal:onion_"..i) */
    lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
    lua_pushliteral(L,"register_alias");
    lua_gettable(L,-2);
    lua_remove(L,-2);
    lua_pushliteral(L,"ethereal:wild_onion_");
    lua_pushvalue(L,(1 + lc_nextra));
    lua_concat(L,2);
    lua_pushliteral(L,"ethereal:onion_");
    lua_pushvalue(L,(1 + lc_nextra));
    lua_concat(L,2);
    lua_call(L,2,0);
    assert(lua_gettop(L) - lc_nextra == 1);
    
    /* internal: stack cleanup on scope exit */
    lua_pop(L,1);
    lc1_var += lc3_step;
  }
  lua_settop(L,(lc4 + lc_nextra));
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* minetest.register_alias("ethereal:onion_7", "ethereal:onion_4") */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"register_alias");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"ethereal:onion_7");
  lua_pushliteral(L,"ethereal:onion_4");
  lua_call(L,2,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* minetest.register_alias("ethereal:onion_8", "ethereal:onion_5") */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"register_alias");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"ethereal:onion_8");
  lua_pushliteral(L,"ethereal:onion_5");
  lua_call(L,2,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* minetest.register_alias("ethereal:wild_onion_7", "ethereal:onion_4") */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"register_alias");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"ethereal:wild_onion_7");
  lua_pushliteral(L,"ethereal:onion_4");
  lua_call(L,2,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* minetest.register_alias("ethereal:wild_onion_8", "ethereal:onion_5") */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"register_alias");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"ethereal:wild_onion_8");
  lua_pushliteral(L,"ethereal:onion_5");
  lua_call(L,2,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* minetest.register_alias("ethereal:wild_onion_craftingitem", "ethereal:wild_onion_plant") */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"register_alias");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"ethereal:wild_onion_craftingitem");
  lua_pushliteral(L,"ethereal:wild_onion_plant");
  lua_call(L,2,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* minetest.register_alias("ethereal:hearty_stew_cooked", "ethereal:hearty_stew") */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"register_alias");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"ethereal:hearty_stew_cooked");
  lua_pushliteral(L,"ethereal:hearty_stew");
  lua_call(L,2,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* minetest.register_alias("ethereal:obsidian_brick", "default:obsidianbrick") */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"register_alias");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"ethereal:obsidian_brick");
  lua_pushliteral(L,"default:obsidianbrick");
  lua_call(L,2,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* minetest.register_alias("ethereal:crystal_topped_dirt", "ethereal:crystal_dirt") */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"register_alias");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"ethereal:crystal_topped_dirt");
  lua_pushliteral(L,"ethereal:crystal_dirt");
  lua_call(L,2,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* minetest.register_alias("ethereal:fiery_dirt_top", "ethereal:fiery_dirt") */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"register_alias");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"ethereal:fiery_dirt_top");
  lua_pushliteral(L,"ethereal:fiery_dirt");
  lua_call(L,2,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* minetest.register_alias("ethereal:gray_dirt_top", "ethereal:gray_dirt") */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"register_alias");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"ethereal:gray_dirt_top");
  lua_pushliteral(L,"ethereal:gray_dirt");
  lua_call(L,2,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* minetest.register_alias("ethereal:green_dirt_top", "ethereal:green_dirt") */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"register_alias");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"ethereal:green_dirt_top");
  lua_pushliteral(L,"ethereal:green_dirt");
  lua_call(L,2,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* minetest.register_alias("ethereal:tree_sapling", "default:sapling") */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"register_alias");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"ethereal:tree_sapling");
  lua_pushliteral(L,"default:sapling");
  lua_call(L,2,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* minetest.register_alias("ethereal:jungle_tree_sapling", "default:junglesapling") */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"register_alias");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"ethereal:jungle_tree_sapling");
  lua_pushliteral(L,"default:junglesapling");
  lua_call(L,2,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* minetest.register_alias("ethereal:acacia_sapling", "default:acacia_sapling") */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"register_alias");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"ethereal:acacia_sapling");
  lua_pushliteral(L,"default:acacia_sapling");
  lua_call(L,2,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* minetest.register_alias("ethereal:pine_tree_sapling", "default:pine_sapling") */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"register_alias");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"ethereal:pine_tree_sapling");
  lua_pushliteral(L,"default:pine_sapling");
  lua_call(L,2,0);
  assert(lua_gettop(L) - lc_nextra == 0);
  return 0;
}


/* from lua.c */
static int traceback (lua_State *L) {
  if (!lua_isstring(L, 1))  /* 'message' not a string? */
    return 1;  /* keep it intact */
  lua_getfield(L, LUA_GLOBALSINDEX, "debug");
  if (!lua_istable(L, -1)) {
    lua_pop(L, 1);
    return 1;
  }
  lua_getfield(L, -1, "traceback");
  if (!lua_isfunction(L, -1)) {
    lua_pop(L, 2);
    return 1;
  }
  lua_pushvalue(L, 1);  /* pass error message */
  lua_pushinteger(L, 2);  /* skip this function and traceback */
  lua_call(L, 2, 1);  /* call debug.traceback */
  return 1;
}


static void lc_l_message (const char *pname, const char *msg) {
  if (pname) fprintf(stderr, "%s: ", pname);
  fprintf(stderr, "%s\n", msg);
  fflush(stderr);
}

static int lc_report (lua_State *L, int status) {
  if (status && !lua_isnil(L, -1)) {
    const char *msg = lua_tostring(L, -1);
    if (msg == NULL) msg = "(error object is not a string)";
    /*FIX-IMROVE:progname*/
    lc_l_message("lua", msg);
    lua_pop(L, 1);
  }
  return status;
}

static int lc_docall (lua_State *L, int narg, int clear) {
  int status;
  int base = lua_gettop(L) - narg;  /* function index */
  lua_pushcfunction(L, traceback);  /* push traceback function */
  lua_insert(L, base);  /* put it under chunk and args */
  /*FIX? signal(SIGINT, laction); */
  status = lua_pcall(L, narg, (clear ? 0 : LUA_MULTRET), base);
  /*FIX? signal(SIGINT, SIG_DFL); */
  lua_remove(L, base);  /* remove traceback function */
  /* force a complete garbage collection in case of errors */
  if (status != 0) lua_gc(L, LUA_GCCOLLECT, 0);
  return status;
}

static int lc_dofile (lua_State *L, const char *name) {
  int status = luaL_loadfile(L, name) || lc_docall(L, 0, 1);
  return lc_report(L, status);
}

static int lc_dostring (lua_State *L, const char *s, const char *name) {
  int status = luaL_loadbuffer(L, s, strlen(s), name) || lc_docall(L, 0, 1);
  return lc_report(L, status);
}

static int lc_handle_luainit (lua_State *L) {
  const char *init = getenv(LUA_INIT);
  if (init == NULL) return 0;  /* status OK */
  else if (init[0] == '@')
    return lc_dofile(L, init+1);
  else
    return lc_dostring(L, init, "=" LUA_INIT);
}


typedef struct {
  int c;
  const char ** v;
} lc_args_t;


/* create global arg table */
static void lc_createarg(lua_State * L, const lc_args_t * const args) {
  int i;
  lua_newtable(L);
  for (i=0; i < args->c; i++) {
    lua_pushstring(L, args->v[i]);
    lua_rawseti(L, -2, i);
  }
  lua_setglobal(L, "arg");
}


int lc_pmain_mod_ethereal_compatibility(lua_State * L) {
  luaL_openlibs(L);

  lua_pushcfunction(L, traceback);

  const int status1 = lc_handle_luainit(L);
  if (status1 != 0) return 0;

  /* note: IMPROVE: closure not always needed here */
  lua_newtable(L); /* closure table */
  lua_pushcclosure(L, lcf_main, 1);

  int status2 = lua_pcall(L, 0, 0, -2);
  if (status2 != 0) {
    const char * msg = lua_tostring(L,-1);
    if (msg == NULL) msg = "(error object is not a string)";
    fputs(msg, stderr);
  }
  return 0;
}


