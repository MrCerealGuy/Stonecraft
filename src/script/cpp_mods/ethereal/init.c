/* WARNING: This file was automatically generated by lua2c. */

#ifdef __cplusplus
extern "C" {
#endif
#include <lua.h>
#include <lauxlib.h>
#include <lualib.h>
#ifdef __cplusplus
}
#endif
#include <stdio.h>
#include <stdlib.h>


#include <string.h>


#include <assert.h>

#include "cpp_mods/cpp_mods_init.h"

/* name: S
 * function(s) */
static int lcf1_S (lua_State * L) {
  enum { lc_nformalargs = 1 };
  lua_settop(L,1);
  
  /* return s */
  lua_pushvalue(L,1);
  return 1;
  assert(lua_gettop(L) == 1);
}


/* name: (main)
 * function(...) */
static int lcf_main (lua_State * L) {
  enum { lc_nformalargs = 0 };
  const int lc_nactualargs = lua_gettop(L);
  const int lc_nextra = (lc_nactualargs - lc_nformalargs);
  
  /* ethereal = {} */
  lua_newtable(L);
  lua_setfield(L,LUA_ENVIRONINDEX,"ethereal");
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* ethereal.leaftype = 0 */
  lua_pushnumber(L,0);
  lua_getfield(L,LUA_ENVIRONINDEX,"ethereal");
  lua_insert(L,-2);
  lua_pushliteral(L,"leaftype");
  lua_insert(L,-2);
  lua_settable(L,-3);
  lua_pop(L,1);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* -- 0 for 2D plantlike, 1 for 3D allfaces
   * ethereal.leafwalk = false */
  lua_pushboolean(L,0);
  lua_getfield(L,LUA_ENVIRONINDEX,"ethereal");
  lua_insert(L,-2);
  lua_pushliteral(L,"leafwalk");
  lua_insert(L,-2);
  lua_settable(L,-3);
  lua_pop(L,1);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* -- true for walkable leaves, false to fall through
   * ethereal.cavedirt = true */
  lua_pushboolean(L,1);
  lua_getfield(L,LUA_ENVIRONINDEX,"ethereal");
  lua_insert(L,-2);
  lua_pushliteral(L,"cavedirt");
  lua_insert(L,-2);
  lua_settable(L,-3);
  lua_pop(L,1);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* -- caves chop through dirt when true
   * -- Set following to 1 to enable biome or 0 to disable
   * ethereal.glacier   = 1 */
  lua_pushnumber(L,1);
  lua_getfield(L,LUA_ENVIRONINDEX,"ethereal");
  lua_insert(L,-2);
  lua_pushliteral(L,"glacier");
  lua_insert(L,-2);
  lua_settable(L,-3);
  lua_pop(L,1);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* -- Ice glaciers with snow
   * ethereal.bamboo    = 1 */
  lua_pushnumber(L,1);
  lua_getfield(L,LUA_ENVIRONINDEX,"ethereal");
  lua_insert(L,-2);
  lua_pushliteral(L,"bamboo");
  lua_insert(L,-2);
  lua_settable(L,-3);
  lua_pop(L,1);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* -- Bamboo with sprouts
   * ethereal.mesa      = 1 */
  lua_pushnumber(L,1);
  lua_getfield(L,LUA_ENVIRONINDEX,"ethereal");
  lua_insert(L,-2);
  lua_pushliteral(L,"mesa");
  lua_insert(L,-2);
  lua_settable(L,-3);
  lua_pop(L,1);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* -- Mesa red and orange clay with giant redwood
   * ethereal.alpine    = 1 */
  lua_pushnumber(L,1);
  lua_getfield(L,LUA_ENVIRONINDEX,"ethereal");
  lua_insert(L,-2);
  lua_pushliteral(L,"alpine");
  lua_insert(L,-2);
  lua_settable(L,-3);
  lua_pop(L,1);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* -- Snowy grass
   * ethereal.healing   = 1 */
  lua_pushnumber(L,1);
  lua_getfield(L,LUA_ENVIRONINDEX,"ethereal");
  lua_insert(L,-2);
  lua_pushliteral(L,"healing");
  lua_insert(L,-2);
  lua_settable(L,-3);
  lua_pop(L,1);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* -- Snowy peaks with healing trees
   * ethereal.snowy     = 1 */
  lua_pushnumber(L,1);
  lua_getfield(L,LUA_ENVIRONINDEX,"ethereal");
  lua_insert(L,-2);
  lua_pushliteral(L,"snowy");
  lua_insert(L,-2);
  lua_settable(L,-3);
  lua_pop(L,1);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* -- Cold grass with pine trees and snow spots
   * ethereal.frost     = 1 */
  lua_pushnumber(L,1);
  lua_getfield(L,LUA_ENVIRONINDEX,"ethereal");
  lua_insert(L,-2);
  lua_pushliteral(L,"frost");
  lua_insert(L,-2);
  lua_settable(L,-3);
  lua_pop(L,1);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* -- Blue dirt with blue/pink frost trees
   * ethereal.grassy    = 1 */
  lua_pushnumber(L,1);
  lua_getfield(L,LUA_ENVIRONINDEX,"ethereal");
  lua_insert(L,-2);
  lua_pushliteral(L,"grassy");
  lua_insert(L,-2);
  lua_settable(L,-3);
  lua_pop(L,1);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* -- Green grass with flowers and trees
   * ethereal.caves     = 1 */
  lua_pushnumber(L,1);
  lua_getfield(L,LUA_ENVIRONINDEX,"ethereal");
  lua_insert(L,-2);
  lua_pushliteral(L,"caves");
  lua_insert(L,-2);
  lua_settable(L,-3);
  lua_pop(L,1);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* -- Desert stone ares with huge caverns underneath
   * ethereal.grayness  = 1 */
  lua_pushnumber(L,1);
  lua_getfield(L,LUA_ENVIRONINDEX,"ethereal");
  lua_insert(L,-2);
  lua_pushliteral(L,"grayness");
  lua_insert(L,-2);
  lua_settable(L,-3);
  lua_pop(L,1);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* -- Grey grass with willow trees
   * ethereal.grassytwo = 1 */
  lua_pushnumber(L,1);
  lua_getfield(L,LUA_ENVIRONINDEX,"ethereal");
  lua_insert(L,-2);
  lua_pushliteral(L,"grassytwo");
  lua_insert(L,-2);
  lua_settable(L,-3);
  lua_pop(L,1);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* -- Sparse trees with old trees and flowers
   * ethereal.prairie   = 1 */
  lua_pushnumber(L,1);
  lua_getfield(L,LUA_ENVIRONINDEX,"ethereal");
  lua_insert(L,-2);
  lua_pushliteral(L,"prairie");
  lua_insert(L,-2);
  lua_settable(L,-3);
  lua_pop(L,1);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* -- Flowery grass with many plants and flowers
   * ethereal.jumble    = 1 */
  lua_pushnumber(L,1);
  lua_getfield(L,LUA_ENVIRONINDEX,"ethereal");
  lua_insert(L,-2);
  lua_pushliteral(L,"jumble");
  lua_insert(L,-2);
  lua_settable(L,-3);
  lua_pop(L,1);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* -- Green grass with trees and jungle grass
   * ethereal.junglee   = 1 */
  lua_pushnumber(L,1);
  lua_getfield(L,LUA_ENVIRONINDEX,"ethereal");
  lua_insert(L,-2);
  lua_pushliteral(L,"junglee");
  lua_insert(L,-2);
  lua_settable(L,-3);
  lua_pop(L,1);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* -- Jungle grass with tall jungle trees
   * ethereal.desert    = 1 */
  lua_pushnumber(L,1);
  lua_getfield(L,LUA_ENVIRONINDEX,"ethereal");
  lua_insert(L,-2);
  lua_pushliteral(L,"desert");
  lua_insert(L,-2);
  lua_settable(L,-3);
  lua_pop(L,1);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* -- Desert sand with cactus
   * ethereal.grove     = 1 */
  lua_pushnumber(L,1);
  lua_getfield(L,LUA_ENVIRONINDEX,"ethereal");
  lua_insert(L,-2);
  lua_pushliteral(L,"grove");
  lua_insert(L,-2);
  lua_settable(L,-3);
  lua_pop(L,1);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* -- Banana groves and ferns
   * ethereal.mushroom  = 1 */
  lua_pushnumber(L,1);
  lua_getfield(L,LUA_ENVIRONINDEX,"ethereal");
  lua_insert(L,-2);
  lua_pushliteral(L,"mushroom");
  lua_insert(L,-2);
  lua_settable(L,-3);
  lua_pop(L,1);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* -- Purple grass with giant mushrooms
   * ethereal.sandstone = 1 */
  lua_pushnumber(L,1);
  lua_getfield(L,LUA_ENVIRONINDEX,"ethereal");
  lua_insert(L,-2);
  lua_pushliteral(L,"sandstone");
  lua_insert(L,-2);
  lua_settable(L,-3);
  lua_pop(L,1);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* -- Sandstone with smaller cactus
   * ethereal.quicksand = 1 */
  lua_pushnumber(L,1);
  lua_getfield(L,LUA_ENVIRONINDEX,"ethereal");
  lua_insert(L,-2);
  lua_pushliteral(L,"quicksand");
  lua_insert(L,-2);
  lua_settable(L,-3);
  lua_pop(L,1);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* -- Quicksand banks
   * ethereal.plains    = 1 */
  lua_pushnumber(L,1);
  lua_getfield(L,LUA_ENVIRONINDEX,"ethereal");
  lua_insert(L,-2);
  lua_pushliteral(L,"plains");
  lua_insert(L,-2);
  lua_settable(L,-3);
  lua_pop(L,1);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* -- Dry dirt with scorched trees
   * ethereal.savannah  = 1 */
  lua_pushnumber(L,1);
  lua_getfield(L,LUA_ENVIRONINDEX,"ethereal");
  lua_insert(L,-2);
  lua_pushliteral(L,"savannah");
  lua_insert(L,-2);
  lua_settable(L,-3);
  lua_pop(L,1);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* -- Dry yellow grass with acacia tree's
   * ethereal.fiery     = 1 */
  lua_pushnumber(L,1);
  lua_getfield(L,LUA_ENVIRONINDEX,"ethereal");
  lua_insert(L,-2);
  lua_pushliteral(L,"fiery");
  lua_insert(L,-2);
  lua_settable(L,-3);
  lua_pop(L,1);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* -- Red grass with lava craters
   * ethereal.sandclay  = 1 */
  lua_pushnumber(L,1);
  lua_getfield(L,LUA_ENVIRONINDEX,"ethereal");
  lua_insert(L,-2);
  lua_pushliteral(L,"sandclay");
  lua_insert(L,-2);
  lua_settable(L,-3);
  lua_pop(L,1);
  assert(lua_gettop(L) - lc_nextra == 0);
  
  /* -- Sand areas with clay underneath
   * -- Intllib
   * local S */
  lua_settop(L,(lua_gettop(L) + 1));
  assert(lua_gettop(L) - lc_nextra == 1);
  
  /* if minetest.get_modpath("intllib") then */
  enum { lc1 = 1 };
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"get_modpath");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"intllib");
  lua_call(L,1,1);
  const int lc2 = lua_toboolean(L,-1);
  lua_pop(L,1);
  if (lc2) {
    
    /* S = intllib.Getter() */
    lua_getfield(L,LUA_ENVIRONINDEX,"intllib");
    lua_pushliteral(L,"Getter");
    lua_gettable(L,-2);
    lua_remove(L,-2);
    lua_call(L,0,1);
    lua_replace(L,(1 + lc_nextra));
    assert(lua_gettop(L) - lc_nextra == 1);
  }
  else {
    
    /* else
     * S = function(s) return s end */
    lua_pushcfunction(L,lcf1_S);
    lua_replace(L,(1 + lc_nextra));
    assert(lua_gettop(L) - lc_nextra == 1);
  }
  lua_settop(L,(lc1 + lc_nextra));
  assert(lua_gettop(L) - lc_nextra == 1);
  
  /* ethereal.intllib = S */
  lua_pushvalue(L,(1 + lc_nextra));
  lua_getfield(L,LUA_ENVIRONINDEX,"ethereal");
  lua_insert(L,-2);
  lua_pushliteral(L,"intllib");
  lua_insert(L,-2);
  lua_settable(L,-3);
  lua_pop(L,1);
  assert(lua_gettop(L) - lc_nextra == 1);
  
  /* local path = minetest.get_modpath("ethereal") */
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"get_modpath");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"ethereal");
  lua_call(L,1,1);
  assert(lua_gettop(L) - lc_nextra == 2);
  
  /* dofile(path .. "/plantlife.lua") */
  lc_pmain_mod_ethereal_plantlife(L);
  /* lua_getfield(L,LUA_ENVIRONINDEX,"dofile");
  lua_pushvalue(L,(2 + lc_nextra));
  lua_pushliteral(L,"/plantlife.lua");
  lua_concat(L,2);
  lua_call(L,1,0);
  assert(lua_gettop(L) - lc_nextra == 2); */
  
  /* dofile(path .. "/mushroom.lua") */
  lc_pmain_mod_ethereal_mushroom(L);
  /* lua_getfield(L,LUA_ENVIRONINDEX,"dofile");
  lua_pushvalue(L,(2 + lc_nextra));
  lua_pushliteral(L,"/mushroom.lua");
  lua_concat(L,2);
  lua_call(L,1,0);
  assert(lua_gettop(L) - lc_nextra == 2); */
  
  /* dofile(path .. "/onion.lua") */
  lc_pmain_mod_ethereal_onion(L);
  /* lua_getfield(L,LUA_ENVIRONINDEX,"dofile");
  lua_pushvalue(L,(2 + lc_nextra));
  lua_pushliteral(L,"/onion.lua");
  lua_concat(L,2);
  lua_call(L,1,0);
  assert(lua_gettop(L) - lc_nextra == 2); */
  
  /* dofile(path .. "/crystal.lua") */
  lc_pmain_mod_ethereal_crystal(L);
  /* lua_getfield(L,LUA_ENVIRONINDEX,"dofile");
  lua_pushvalue(L,(2 + lc_nextra));
  lua_pushliteral(L,"/crystal.lua");
  lua_concat(L,2);
  lua_call(L,1,0);
  assert(lua_gettop(L) - lc_nextra == 2); */
  
  /* dofile(path .. "/water.lua") */
  lc_pmain_mod_ethereal_water(L);
  /* lua_getfield(L,LUA_ENVIRONINDEX,"dofile");
  lua_pushvalue(L,(2 + lc_nextra));
  lua_pushliteral(L,"/water.lua");
  lua_concat(L,2);
  lua_call(L,1,0);
  assert(lua_gettop(L) - lc_nextra == 2); */
  
  /* dofile(path .. "/dirt.lua") */
  lc_pmain_mod_ethereal_dirt(L);
  /* lua_getfield(L,LUA_ENVIRONINDEX,"dofile");
  lua_pushvalue(L,(2 + lc_nextra));
  lua_pushliteral(L,"/dirt.lua");
  lua_concat(L,2);
  lua_call(L,1,0);
  assert(lua_gettop(L) - lc_nextra == 2); */
  
  /* dofile(path .. "/leaves.lua") */
  lc_pmain_mod_ethereal_leaves(L);
  /* lua_getfield(L,LUA_ENVIRONINDEX,"dofile");
  lua_pushvalue(L,(2 + lc_nextra));
  lua_pushliteral(L,"/leaves.lua");
  lua_concat(L,2);
  lua_call(L,1,0);
  assert(lua_gettop(L) - lc_nextra == 2); */
  
  /* dofile(path .. "/wood.lua") */
  lc_pmain_mod_ethereal_wood(L);
  /* lua_getfield(L,LUA_ENVIRONINDEX,"dofile");
  lua_pushvalue(L,(2 + lc_nextra));
  lua_pushliteral(L,"/wood.lua");
  lua_concat(L,2);
  lua_call(L,1,0);
  assert(lua_gettop(L) - lc_nextra == 2); */
  
  /* dofile(path .. "/sapling.lua") */
  lc_pmain_mod_ethereal_sapling(L);
  /* lua_getfield(L,LUA_ENVIRONINDEX,"dofile");
  lua_pushvalue(L,(2 + lc_nextra));
  lua_pushliteral(L,"/sapling.lua");
  lua_concat(L,2);
  lua_call(L,1,0);
  assert(lua_gettop(L) - lc_nextra == 2); */
  
  /* dofile(path .. "/strawberry.lua") */
  lc_pmain_mod_ethereal_strawberry(L);
  /* lua_getfield(L,LUA_ENVIRONINDEX,"dofile");
  lua_pushvalue(L,(2 + lc_nextra));
  lua_pushliteral(L,"/strawberry.lua");
  lua_concat(L,2);
  lua_call(L,1,0);
  assert(lua_gettop(L) - lc_nextra == 2); */
  
  /* dofile(path .. "/fishing.lua") */
  lc_pmain_mod_ethereal_fishing(L);
  /* lua_getfield(L,LUA_ENVIRONINDEX,"dofile");
  lua_pushvalue(L,(2 + lc_nextra));
  lua_pushliteral(L,"/fishing.lua");
  lua_concat(L,2);
  lua_call(L,1,0);
  assert(lua_gettop(L) - lc_nextra == 2); */
  
  /* dofile(path .. "/extra.lua") */
  lc_pmain_mod_ethereal_extra(L);
  /* lua_getfield(L,LUA_ENVIRONINDEX,"dofile");
  lua_pushvalue(L,(2 + lc_nextra));
  lua_pushliteral(L,"/extra.lua");
  lua_concat(L,2);
  lua_call(L,1,0);
  assert(lua_gettop(L) - lc_nextra == 2); */
  
  /* dofile(path .. "/sealife.lua") */
  lc_pmain_mod_ethereal_sealife(L);
  /* lua_getfield(L,LUA_ENVIRONINDEX,"dofile");
  lua_pushvalue(L,(2 + lc_nextra));
  lua_pushliteral(L,"/sealife.lua");
  lua_concat(L,2);
  lua_call(L,1,0);
  assert(lua_gettop(L) - lc_nextra == 2); */
  
  /* dofile(path .. "/fences.lua") */
  lc_pmain_mod_ethereal_fences(L);
  /* lua_getfield(L,LUA_ENVIRONINDEX,"dofile");
  lua_pushvalue(L,(2 + lc_nextra));
  lua_pushliteral(L,"/fences.lua");
  lua_concat(L,2);
  lua_call(L,1,0);
  assert(lua_gettop(L) - lc_nextra == 2); */
  
  /* dofile(path .. "/gates.lua") */
  lc_pmain_mod_ethereal_gates(L);
  /* lua_getfield(L,LUA_ENVIRONINDEX,"dofile");
  lua_pushvalue(L,(2 + lc_nextra));
  lua_pushliteral(L,"/gates.lua");
  lua_concat(L,2);
  lua_call(L,1,0);
  assert(lua_gettop(L) - lc_nextra == 2); */
  
  /* dofile(path .. "/mapgen.lua") */
  lc_pmain_mod_ethereal_mapgen(L);
  /* lua_getfield(L,LUA_ENVIRONINDEX,"dofile");
  lua_pushvalue(L,(2 + lc_nextra));
  lua_pushliteral(L,"/mapgen.lua");
  lua_concat(L,2);
  lua_call(L,1,0);
  assert(lua_gettop(L) - lc_nextra == 2); */
  
  /* dofile(path .. "/food.lua") */
  lc_pmain_mod_ethereal_food(L);
  /* lua_getfield(L,LUA_ENVIRONINDEX,"dofile");
  lua_pushvalue(L,(2 + lc_nextra));
  lua_pushliteral(L,"/food.lua");
  lua_concat(L,2);
  lua_call(L,1,0);
  assert(lua_gettop(L) - lc_nextra == 2); */
  
  /* dofile(path .. "/bonemeal.lua") */
  lc_pmain_mod_ethereal_bonemeal(L);
  /* lua_getfield(L,LUA_ENVIRONINDEX,"dofile");
  lua_pushvalue(L,(2 + lc_nextra));
  lua_pushliteral(L,"/bonemeal.lua");
  lua_concat(L,2);
  lua_call(L,1,0);
  assert(lua_gettop(L) - lc_nextra == 2); */
  
  /* dofile(path .. "/compatibility.lua") */
  lc_pmain_mod_ethereal_compatibility(L);
  /* lua_getfield(L,LUA_ENVIRONINDEX,"dofile");
  lua_pushvalue(L,(2 + lc_nextra));
  lua_pushliteral(L,"/compatibility.lua");
  lua_concat(L,2);
  lua_call(L,1,0);
  assert(lua_gettop(L) - lc_nextra == 2); */
  
  /* dofile(path .. "/stairs.lua") */
  lc_pmain_mod_ethereal_stairs(L);
  /* lua_getfield(L,LUA_ENVIRONINDEX,"dofile");
  lua_pushvalue(L,(2 + lc_nextra));
  lua_pushliteral(L,"/stairs.lua");
  lua_concat(L,2);
  lua_call(L,1,0);
  assert(lua_gettop(L) - lc_nextra == 2); */
  
  /* if minetest.get_modpath("xanadu") then */
  enum { lc3 = 2 };
  lua_getfield(L,LUA_ENVIRONINDEX,"minetest");
  lua_pushliteral(L,"get_modpath");
  lua_gettable(L,-2);
  lua_remove(L,-2);
  lua_pushliteral(L,"xanadu");
  lua_call(L,1,1);
  const int lc4 = lua_toboolean(L,-1);
  lua_pop(L,1);
  if (lc4) {
    
    /* dofile(path .. "/plantpack.lua") */
	lc_pmain_mod_ethereal_plantpack(L);
	/* lua_getfield(L,LUA_ENVIRONINDEX,"dofile");
    lua_pushvalue(L,(2 + lc_nextra));
    lua_pushliteral(L,"/plantpack.lua");
    lua_concat(L,2);
    lua_call(L,1,0);
    assert(lua_gettop(L) - lc_nextra == 2); */
  }
  lua_settop(L,(lc3 + lc_nextra));
  assert(lua_gettop(L) - lc_nextra == 2);
  
  /* print (S("[MOD] Ethereal loaded")) */
  lua_getfield(L,LUA_ENVIRONINDEX,"print");
  const int lc5 = lua_gettop(L);
  lua_pushvalue(L,(1 + lc_nextra));
  lua_pushliteral(L,"[MOD] Ethereal loaded");
  lua_call(L,1,LUA_MULTRET);
  lua_call(L,(lua_gettop(L) - lc5),0);
  assert(lua_gettop(L) - lc_nextra == 2);
  return 0;
}


/* from lua.c */
static int traceback (lua_State *L) {
  if (!lua_isstring(L, 1))  /* 'message' not a string? */
    return 1;  /* keep it intact */
  lua_getfield(L, LUA_GLOBALSINDEX, "debug");
  if (!lua_istable(L, -1)) {
    lua_pop(L, 1);
    return 1;
  }
  lua_getfield(L, -1, "traceback");
  if (!lua_isfunction(L, -1)) {
    lua_pop(L, 2);
    return 1;
  }
  lua_pushvalue(L, 1);  /* pass error message */
  lua_pushinteger(L, 2);  /* skip this function and traceback */
  lua_call(L, 2, 1);  /* call debug.traceback */
  return 1;
}


static void lc_l_message (const char *pname, const char *msg) {
  if (pname) fprintf(stderr, "%s: ", pname);
  fprintf(stderr, "%s\n", msg);
  fflush(stderr);
}

static int lc_report (lua_State *L, int status) {
  if (status && !lua_isnil(L, -1)) {
    const char *msg = lua_tostring(L, -1);
    if (msg == NULL) msg = "(error object is not a string)";
    /*FIX-IMROVE:progname*/
    lc_l_message("lua", msg);
    lua_pop(L, 1);
  }
  return status;
}

static int lc_docall (lua_State *L, int narg, int clear) {
  int status;
  int base = lua_gettop(L) - narg;  /* function index */
  lua_pushcfunction(L, traceback);  /* push traceback function */
  lua_insert(L, base);  /* put it under chunk and args */
  /*FIX? signal(SIGINT, laction); */
  status = lua_pcall(L, narg, (clear ? 0 : LUA_MULTRET), base);
  /*FIX? signal(SIGINT, SIG_DFL); */
  lua_remove(L, base);  /* remove traceback function */
  /* force a complete garbage collection in case of errors */
  if (status != 0) lua_gc(L, LUA_GCCOLLECT, 0);
  return status;
}

static int lc_dofile (lua_State *L, const char *name) {
  int status = luaL_loadfile(L, name) || lc_docall(L, 0, 1);
  return lc_report(L, status);
}

static int lc_dostring (lua_State *L, const char *s, const char *name) {
  int status = luaL_loadbuffer(L, s, strlen(s), name) || lc_docall(L, 0, 1);
  return lc_report(L, status);
}

static int lc_handle_luainit (lua_State *L) {
  const char *init = getenv(LUA_INIT);
  if (init == NULL) return 0;  /* status OK */
  else if (init[0] == '@')
    return lc_dofile(L, init+1);
  else
    return lc_dostring(L, init, "=" LUA_INIT);
}


typedef struct {
  int c;
  const char ** v;
} lc_args_t;


/* create global arg table */
static void lc_createarg(lua_State * L, const lc_args_t * const args) {
  int i;
  lua_newtable(L);
  for (i=0; i < args->c; i++) {
    lua_pushstring(L, args->v[i]);
    lua_rawseti(L, -2, i);
  }
  lua_setglobal(L, "arg");
}


int lc_pmain_mod_ethereal_init(lua_State * L) {
  luaL_openlibs(L);

  lua_pushcfunction(L, traceback);

  const int status1 = lc_handle_luainit(L);
  if (status1 != 0) return 0;

  /* note: IMPROVE: closure not always needed here */
  lua_newtable(L); /* closure table */
  lua_pushcclosure(L, lcf_main, 1);

  int status2 = lua_pcall(L, 0, 0, -2);
  if (status2 != 0) {
    const char * msg = lua_tostring(L,-1);
    if (msg == NULL) msg = "(error object is not a string)";
    fputs(msg, stderr);
  }
  return 0;
}


